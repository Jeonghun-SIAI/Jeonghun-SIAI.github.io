<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="ko" class="no-js">

<head>
  <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Í∞ïÌôîÌïôÏäµ Í∏∞Î∞ò ÎßàÏù¥ÌÅ¨Î°úÍ∑∏Î¶¨Îìú ÎÇ¥ Î∞∞ÌÑ∞Î¶¨ Ïä§ÏºÄÏ§ÑÎßÅ - 5) TD3, SACÎ•º ÌÜµÌïú continuous control ÎèÑÏ∂ú | A test page</title>
<meta name="description" content="Ï†ÄÎ≤à Ìè¨Ïä§ÌåÖÏóêÏÑúÎäî continuous controlÏùÑ ÏúÑÌïú Í∏∞Î≥∏Ï†ÅÏù∏ Ïã¨Ï∏µÍ∞ïÌôîÌïôÏäµ Î∞©Î≤ï, Deep Deterministic Policy Gradient (DDPG) Î•º Ï†ÅÏö©Ìï¥ Î≥¥ÏïòÎã§. ÎÜÄÎûçÍ≤åÎèÑ(?) Ïù¥ ÏãúÎ¶¨Ï¶àÏóêÏÑú Îã§Î£®Îäî ÎßàÏù¥ÌÅ¨Î°úÍ∑∏Î¶¨Îìú Î¨∏Ï†úÏóêÏÑúÎäî, DDPGÍ∞Ä Deep Q-learning (discrete action 3Í∞ú) ÎåÄÎπÑ Îçî ÎÇòÏùÄ Í≤∞Í≥ºÎ•º Î≥¥Ïù¥ÏßÄ Î™ªÌñàÎã§.">


  <meta name="author" content="Jeonghun Song">
  
  <meta property="article:author" content="Jeonghun Song">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="ko_KR">
<meta property="og:site_name" content="A test page">
<meta property="og:title" content="Í∞ïÌôîÌïôÏäµ Í∏∞Î∞ò ÎßàÏù¥ÌÅ¨Î°úÍ∑∏Î¶¨Îìú ÎÇ¥ Î∞∞ÌÑ∞Î¶¨ Ïä§ÏºÄÏ§ÑÎßÅ - 5) TD3, SACÎ•º ÌÜµÌïú continuous control ÎèÑÏ∂ú">
<meta property="og:url" content="http://localhost:4000/2023/04/reinforcefive.html">


  <meta property="og:description" content="Ï†ÄÎ≤à Ìè¨Ïä§ÌåÖÏóêÏÑúÎäî continuous controlÏùÑ ÏúÑÌïú Í∏∞Î≥∏Ï†ÅÏù∏ Ïã¨Ï∏µÍ∞ïÌôîÌïôÏäµ Î∞©Î≤ï, Deep Deterministic Policy Gradient (DDPG) Î•º Ï†ÅÏö©Ìï¥ Î≥¥ÏïòÎã§. ÎÜÄÎûçÍ≤åÎèÑ(?) Ïù¥ ÏãúÎ¶¨Ï¶àÏóêÏÑú Îã§Î£®Îäî ÎßàÏù¥ÌÅ¨Î°úÍ∑∏Î¶¨Îìú Î¨∏Ï†úÏóêÏÑúÎäî, DDPGÍ∞Ä Deep Q-learning (discrete action 3Í∞ú) ÎåÄÎπÑ Îçî ÎÇòÏùÄ Í≤∞Í≥ºÎ•º Î≥¥Ïù¥ÏßÄ Î™ªÌñàÎã§.">







  <meta property="article:published_time" content="2023-04-19T00:00:00+09:00">





  

  


<link rel="canonical" href="http://localhost:4000/2023/04/reinforcefive.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Jeonghun Song",
      "url": "http://localhost:4000/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="A test page Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



  <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<head>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
</head>


<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        TeX: {
          equationNumbers: {
            autoNumber: "AMS"
          }
        },
        tex2jax: {
        inlineMath: [ ['$', '$'] ],
        displayMath: [ ['$$', '$$'] ],
        processEscapes: true,
      }
    });
    MathJax.Hub.Register.MessageHook("Math Processing Error",function (message) {
          alert("Math Processing Error: "+message[1]);
        });
    MathJax.Hub.Register.MessageHook("TeX Jax - parse error",function (message) {
          alert("Math Processing Error: "+message[1]);
        });
    </script>
<script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


<!-- end custom head snippets -->
</head>

<body
  class="layout--single">
  <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

  

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/logo.png" alt="A test page"></a>
        
        <a class="site-title" href="/">
          A test page
          <span class="site-subtitle">learning Github Page</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/aboutme/">About Me</a>
            </li><li class="masthead__menu-item">
              <a href="/search/">Search</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/">Category</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/">Tag</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Ïπ¥ÌÖåÍ≥†Î¶¨ Î™©Î°ù</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


  <div class="initial-content">
    




  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/" itemprop="item"><span itemprop="name">Home</span></a>

          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/categories/#2023" itemprop="item"><span itemprop="name">2023</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/categories/#04" itemprop="item"><span itemprop="name">04</span></a>
          <meta itemprop="position" content="3" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">Í∞ïÌôîÌïôÏäµ Í∏∞Î∞ò ÎßàÏù¥ÌÅ¨Î°úÍ∑∏Î¶¨Îìú ÎÇ¥ Î∞∞ÌÑ∞Î¶¨ Ïä§ÏºÄÏ§ÑÎßÅ - 5) TD3, SACÎ•º ÌÜµÌïú continuous control ÎèÑÏ∂ú</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  

  <div class="sidebar sticky">
    
  
  
  
  
    
    
      
    
    
  
  
   <!-- three lines added by Jeonghun  -->
    

<nav class="nav__list">
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Ïπ¥ÌÖåÍ≥†Î¶¨ Î™©Î°ù</label>
  <ul class="nav__items" id="category_tag_menu">
      <!--Ï†ÑÏ≤¥ Í∏Ä Ïàò-->
      <li>
            üìÇ <span style="font-family:'Cafe24Oneprettynight';">Ï†ÑÏ≤¥ Í∏Ä Ïàò</style> <span style="font-family:'Coming Soon';">21</style> <span style="font-family:'Cafe24Oneprettynight';">Í∞ú</style> 
      </li>
      <li>
        <!--span ÌÉúÍ∑∏Î°ú Ïπ¥ÌÖåÍ≥†Î¶¨Îì§ÏùÑ ÌÅ¨Í≤å Î∂ÑÎ•ò ex) C/C++/C#-->
        <span class="nav__sub-title">Î≤îÏ£º1</span>
            <!--ul ÌÉúÍ∑∏Î°ú Í∞ôÏùÄ Ïπ¥ÌÖåÍ≥†Î¶¨Îì§ Î™®ÏïÑÎëî ÌéòÏù¥ÏßÄÎì§ ÎÇòÏó¥-->
            <ul>
                <!--Cpp Ïπ¥ÌÖåÍ≥†Î¶¨ Í∏ÄÎì§ÏùÑ Î™®ÏïÑÎëî ÌéòÏù¥ÏßÄÏù∏ /categories/cpp Ï£ºÏÜåÏùò Í∏ÄÎ°ú ÎßÅÌÅ¨ Ïó∞Í≤∞-->
                <!--category[1].size Î°ú Ìï¥Îãπ Ïπ¥ÌÖåÍ≥†Î¶¨Î•º Í∞ÄÏßÑ Í∏ÄÏùò Í∞úÏàò ÌëúÏãú--> 
                
                    
                
                    
                
                    
                        <li><a href="/code" class="">ÏΩîÎìú (1)</a></li>
                    
                
                    
                
                    
                
            </ul>
            <ul>
                
                    
                
                    
                        <li><a href="/theory" class="">Ïù¥Î°† (2)</a></li>
                    
                
                    
                
                    
                
                    
                
            </ul>
            <ul>
                
                    
                
                    
                
                    
                
                    
                
                    
                        <li><a href="/energy" class="">ÏóêÎÑàÏßÄ (15)</a></li>
                    
                
            </ul>
        <span class="nav__sub-title">Î≤îÏ£º2</span>
            <ul>
                
                    
                
                    
                
                    
                
                    
                        <li><a href="/project" class="">ÌîÑÎ°úÏ†ùÌä∏ (1)</a></li>
                    
                
                    
                
            </ul>
            <ul>
                
                    
                        <li><a href="/etc" class="">Í∏∞ÌÉÄ (2)</a></li>
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
      </li>
  </ul>
</nav>
  
  

  </div>




  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Í∞ïÌôîÌïôÏäµ Í∏∞Î∞ò ÎßàÏù¥ÌÅ¨Î°úÍ∑∏Î¶¨Îìú ÎÇ¥ Î∞∞ÌÑ∞Î¶¨ Ïä§ÏºÄÏ§ÑÎßÅ - 5) TD3, SACÎ•º ÌÜµÌïú continuous control ÎèÑÏ∂ú">
    <meta itemprop="description" content="Ï†ÄÎ≤à Ìè¨Ïä§ÌåÖÏóêÏÑúÎäî continuous controlÏùÑ ÏúÑÌïú Í∏∞Î≥∏Ï†ÅÏù∏ Ïã¨Ï∏µÍ∞ïÌôîÌïôÏäµ Î∞©Î≤ï, Deep Deterministic Policy Gradient (DDPG) Î•º Ï†ÅÏö©Ìï¥ Î≥¥ÏïòÎã§. ÎÜÄÎûçÍ≤åÎèÑ(?) Ïù¥ ÏãúÎ¶¨Ï¶àÏóêÏÑú Îã§Î£®Îäî ÎßàÏù¥ÌÅ¨Î°úÍ∑∏Î¶¨Îìú Î¨∏Ï†úÏóêÏÑúÎäî, DDPGÍ∞Ä Deep Q-learning (discrete action 3Í∞ú) ÎåÄÎπÑ Îçî ÎÇòÏùÄ Í≤∞Í≥ºÎ•º Î≥¥Ïù¥ÏßÄ Î™ªÌñàÎã§.">
    <meta itemprop="datePublished" content="2023-04-19T00:00:00+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="http://localhost:4000/2023/04/reinforcefive.html" class="u-url" itemprop="url">Í∞ïÌôîÌïôÏäµ Í∏∞Î∞ò ÎßàÏù¥ÌÅ¨Î°úÍ∑∏Î¶¨Îìú ÎÇ¥ Î∞∞ÌÑ∞Î¶¨ Ïä§ÏºÄÏ§ÑÎßÅ - 5) TD3, SACÎ•º ÌÜµÌïú continuous control ÎèÑÏ∂ú
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-04-19T00:00:00+09:00">2023-04-19</time>
      </span>
    

    

    
  </p>


        </header>
      

      <section class="page__content e-content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> Contents</h4></header> 
              <ul class="toc__menu"><li><a href="#td3">TD3</a></li><li><a href="#sac">SAC</a></li><li><a href="#Í≤∞Í≥º">Í≤∞Í≥º</a></li><li><a href="#ÎÇòÍ∞ÄÎ©∞">ÎÇòÍ∞ÄÎ©∞</a></li></ul>
 <!-- Ïö∞Ï∏° TOC -->
            </nav>
          </aside>
        
        <p>Ï†ÄÎ≤à Ìè¨Ïä§ÌåÖÏóêÏÑúÎäî continuous controlÏùÑ ÏúÑÌïú Í∏∞Î≥∏Ï†ÅÏù∏ Ïã¨Ï∏µÍ∞ïÌôîÌïôÏäµ Î∞©Î≤ï, Deep Deterministic Policy Gradient (DDPG) Î•º Ï†ÅÏö©Ìï¥ Î≥¥ÏïòÎã§. ÎÜÄÎûçÍ≤åÎèÑ(?) Ïù¥ ÏãúÎ¶¨Ï¶àÏóêÏÑú Îã§Î£®Îäî ÎßàÏù¥ÌÅ¨Î°úÍ∑∏Î¶¨Îìú Î¨∏Ï†úÏóêÏÑúÎäî, DDPGÍ∞Ä Deep Q-learning (discrete action 3Í∞ú) ÎåÄÎπÑ Îçî ÎÇòÏùÄ Í≤∞Í≥ºÎ•º Î≥¥Ïù¥ÏßÄ Î™ªÌñàÎã§.</p>

<p>Continuous control ÌïôÏäµÏóê ÎåÄÌï¥ Îçî ÏßÑÎ≥¥Îêú Î∞©Î≤ïÏùÑ Ïì¥Îã§Î©¥ Ïñ¥Îñ®Íπå? ÏßÑÎ≥¥Îêú Î∞©Î≤ïÎì§Ïùò ÎåÄÌëú ÏÇ¨Î°ÄÎì§Î°ú, <a href="https://arxiv.org/abs/1802.09477">Twin Delayed Deep Deterministic policy gradient (TD3)</a>ÏôÄ <a href="https://arxiv.org/abs/1812.05905">Soft Actor-Critic (SAC)</a>Ïù¥ ÏûàÎã§.</p>

<p><br /></p>
<h2 id="td3">TD3</h2>

<p>TD3Í∞Ä DDPGÏôÄ ÎπÑÍµêÌï¥ Í∞ñÎäî Ï∞®Ïù¥Ï†êÏùÄ ÎåÄÎûµ ÏïÑÎûòÏôÄ Í∞ôÎã§ (Ìï≠ÏÉÅ Í∑∏Î†áÏßÄÎßå ÏÉÅÏÑ∏Ìïú ÎÇ¥Ïö©ÏùÄ ÎÖºÎ¨∏ ÏõêÎ¨∏ÏùÑ Ï∞∏Í≥†ÌïòÏûê).</p>

<ul>
  <li>critic Ïã†Í≤ΩÎßù Ìïú Í∞úÍ∞Ä ÏïÑÎãå Îëê Í∞úÎ•º ÏÇ¨Ïö©Ìï®. Í∑∏Î¶¨Í≥† $Q(s_{t+1},a_{t+1})$ÏùÑ Îëê Í∞úÏùò target critic Ïã†Í≤ΩÎßù Í∞ÅÍ∞ÅÏóê ÎåÄÌï¥ Í≥ÑÏÇ∞ÌïòÍ≥† Í∑∏ Ï§ë ‚ÄòÎçî ÏûëÏùÄ Í∞í‚ÄôÏùÑ ÏÇ¨Ïö©Ìï®. ÎßàÏ∞¨Í∞ÄÏßÄÎ°ú actor ÌõàÎ†®ÏãúÏùò Î™©Ï†ÅÌï®Ïàò ÎÇ¥ $Q(s_{t},a_{t})$ ÎòêÌïú Îëê critic Ïã†Í≤ΩÎßù Í∞ÅÍ∞ÅÏóê ÎåÄÌï¥ Í≥ÑÏÇ∞ÌïòÍ≥† Í∑∏ Ï§ë ‚ÄòÎçî ÏûëÏùÄ Í∞í‚ÄôÏùÑ ÏÇ¨Ïö©Ìï®. Ïù¥Î•º ÌÜµÌï¥ Q-learning ÌäπÏú†Ïùò overestimation Î¨∏Ï†úÎ•º Í≤ΩÍ∞êÌï† Ïàò ÏûàÏùå.</li>
  <li>$a_{t+1}$ÏùÑ Í≤∞Ï†ï Ïãú actorÏùò Í≤∞Í≥ºÎ•º Í∑∏ÎåÄÎ°ú Ïì∞Îäî Í≤å ÏïÑÎãàÎùº, clipped noiseÎ•º Ï∂îÍ∞ÄÌïòÏó¨ smoothing regularization Ìö®Í≥ºÎ•º ÏñªÏùå.</li>
  <li>CriticÏù¥ Îëê Î≤à ÏóÖÎç∞Ïù¥Ìä∏Îê† ÎèôÏïà actorÎäî Ìïú Î≤à ÏóÖÎç∞Ïù¥Ìä∏Îê®, Ïù¥Îü¨Ìïú `delayed‚Äô policy updateÎ•º ÌÜµÌï¥ value estimationÏùò varianceÎ•º Ï§ÑÏûÑ.</li>
</ul>

<p>TD3 ÌõàÎ†® ÏΩîÎìúÎäî ÏïÑÎûòÏôÄ Í∞ôÎã§.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># -*- coding: utf-8 -*-
</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">from</span> <span class="n">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="n">keras.layers</span> <span class="kn">import</span> <span class="n">Input</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Conv1D</span><span class="p">,</span> <span class="n">concatenate</span><span class="p">,</span> <span class="n">Flatten</span>
<span class="kn">import</span> <span class="n">time</span>

<span class="c1">### hyperparameters
</span>

<span class="n">actor_lr</span> <span class="o">=</span> <span class="mf">0.0001</span> <span class="c1"># learning rate ÎÑàÎ¨¥ ÌÅ¨Í≤å ÌïòÎ©¥ Î∞úÏÇ∞ÌïòÎäî Í≤ΩÏö∞ ÏûàÏúºÎØÄÎ°ú Ï£ºÏùò, ÌõàÎ†®Ïù¥ ÏßÄÏÜçÎê†ÏàòÎ°ù profitÏù¥ Ïò§ÌûàÎ†§ ÏùºÍ¥ÄÎêòÍ≤å Í∞êÏÜåÌïòÎ©¥ learning rateÎ•º ÎÇÆÏ∂∞Î≥¥Îäî Í≤å Ï¢ãÏùå
</span><span class="n">critic_lr</span> <span class="o">=</span> <span class="mf">0.0002</span>
<span class="n">tau</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="c1"># target NNÎì§ ÏóÖÎç∞Ïù¥Ìä∏ Í¥ÄÎ†®
</span><span class="n">rewardscalefactor</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">6</span>
<span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">20000</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">discount_factor</span> <span class="o">=</span> <span class="mf">0.98</span>
<span class="n">clippednoise_std</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">clippednoise_interval</span> <span class="o">=</span> <span class="mf">0.15</span>
<span class="n">period_step_fortrain</span> <span class="o">=</span> <span class="mi">24</span>




<span class="c1">### microgrid system data
</span>
<span class="n">PV_prod_train</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="s">'BelgiumPV_prod_train.npy'</span><span class="p">)</span> <span class="c1"># [0,1] Íµ¨Í∞Ñ ÎÇ¥Î°ú scaledÎêú Îç∞Ïù¥ÌÑ∞ÏûÑ, unscalingÏùÄ play_one_step Ìï®Ïàò ÎÇ¥ÏóêÏÑú Ïù¥Î£®Ïñ¥Ïßê
</span><span class="n">PV_prod_test</span>  <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="s">'BelgiumPV_prod_test.npy'</span><span class="p">)</span> 

<span class="n">load_train</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="s">'example_nondeterminist_cons_train.npy'</span><span class="p">)</span> <span class="c1"># [0,1] Íµ¨Í∞Ñ ÎÇ¥Î°ú scaledÎêú Îç∞Ïù¥ÌÑ∞ÏûÑ, unscalingÏùÄ play_one_step Ìï®Ïàò ÎÇ¥ÏóêÏÑú Ïù¥Î£®Ïñ¥Ïßê
</span><span class="n">load_test</span>  <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="s">'example_nondeterminist_cons_test.npy'</span><span class="p">)</span>

<span class="n">prate_h2</span> <span class="o">=</span> <span class="mf">1.1</span> <span class="c1"># ÏàòÏÜåÌÉ±ÌÅ¨Í∏∞Ï§ÄÏúºÎ°ú ÏµúÎåÄ Ïú†Ï∂úÏûÖÍ∞ÄÎä•Îüâ
</span><span class="n">eff_h2</span> <span class="o">=</span> <span class="mf">0.65</span> <span class="c1"># ÏàòÏÜå-Ï†ÑÍ∏∞ Î≥ÄÌôòÌö®Ïú®
</span>
<span class="n">capa_batt</span> <span class="o">=</span> <span class="mi">15</span> <span class="c1"># Î∞∞ÌÑ∞Î¶¨ Ïö©Îüâ (Í≤âÎ≥¥Í∏∞Ïö©Îüâ ÎßêÍ≥† SOC ÏÉÅÌïòÌïú Í≥†Î†§Ìïú Ïã§Ïö©ÎüâÏù¥Îùº Í∞ÄÏ†ï)
</span><span class="n">eff_batt</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="c1"># Î∞∞ÌÑ∞Î¶¨ Ï∂©Î∞©Ï†Ñ Ìö®Ïú®
</span><span class="n">initialenergy_batt</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># epochÏùò ÏãúÏûëÏóêÏÑú Î∞∞ÌÑ∞Î¶¨ ÎÇ¥ ÏóêÎÑàÏßÄÎüâ (ÏµúÎåÄÏ†ÄÏû•Í∞ÄÎä•Îüâ ÎåÄÎπÑ ÏÉÅÎåÄÎπÑÏú®, Qval NNÏóêÎäî Ïù¥ ÏÉÅÎåÄÎπÑÏú®Ïù¥ ÏûÖÎ†•ÎêòÎ©∞, play_one_step Ìï®Ïàò ÎÇ¥ÏóêÏÑúÏùò ÏóêÎÑàÏßÄÏãúÏä§ÌÖú Î∞∏Îü∞Ïä§ ÏàòÏãùÏóêÏÑúÎäî Ïã§Ï†ú ÏóêÎÑàÏßÄÍ∞íÏúºÎ°ú Î≥ÄÌôòÎê®
</span>
<span class="n">price_h2</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">cost_loss</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">maxpower_h2</span> <span class="o">=</span> <span class="mf">1.1</span>

<span class="n">load_peak</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">pv_peak</span> <span class="o">=</span> <span class="mi">12</span>

<span class="n">inputlen_load</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">inputlen_pv</span> <span class="o">=</span> <span class="mi">24</span>



<span class="c1">### Neural net configuration
</span>
<span class="k">class</span> <span class="nc">Critic</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span> <span class="c1"># Q-valueÎ•º Ï∂îÏ†ïÌïòÎäî NN (actionÏù¥ continuous)
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">Critic</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span> <span class="c1"># tf.Keras.Model ÏÉÅÏÜçÎ∞õÎäî Ïù¥Ïú†Îäî mainÏΩîÎìúÏóêÏÑú get_weights, set_weights Îì±ÏùÑ Îß§Î≤à model Î©îÏÜåÎìúÎ•º Î∂àÎü¨Ïò§ÏßÄ ÏïäÍ≥†ÎèÑ Ìé∏ÌïòÍ≤å Ïì∞Í∏∞ ÏúÑÌï®          
</span>        <span class="n">self</span><span class="p">.</span><span class="n">input_load</span> <span class="o">=</span> <span class="nc">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">inputlen_load</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># Í≥ºÍ±∞ 12ÏãúÍ∞ÑÏùò Î∂ÄÌïò, shapeÏùò ÎëêÎ≤àÏß∏ Ïà´ÏûêÎäî Ï±ÑÎÑê Ïàò (Ïª¨Îü¨ÏÇ¨ÏßÑÏùò RGB Í∞ôÏùÄ), Ïù¥Í≤å ÏûàÏñ¥Ïïº Conv1DÍ∞Ä ÏûëÎèôÌï®
</span>        <span class="n">self</span><span class="p">.</span><span class="n">input_pv</span> <span class="o">=</span> <span class="nc">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">inputlen_pv</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># Í≥ºÍ±∞ 12ÏãúÍ∞ÑÏùò ÌÉúÏñëÍ¥ëÎ∞úÏ†ÑÎüâ
</span>        <span class="n">self</span><span class="p">.</span><span class="n">hidden_conv_load</span> <span class="o">=</span> <span class="nc">Conv1D</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">input_load</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hidden_conv_pv</span> <span class="o">=</span> <span class="nc">Conv1D</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">input_pv</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">concat_conv</span> <span class="o">=</span> <span class="nf">concatenate</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="n">hidden_conv_load</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="n">hidden_conv_pv</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hidden_conv_concat</span> <span class="o">=</span> <span class="nc">Conv1D</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">concat_conv</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">flatten_conv</span> <span class="o">=</span> <span class="nc">Flatten</span><span class="p">()(</span><span class="n">self</span><span class="p">.</span><span class="n">hidden_conv_concat</span><span class="p">)</span> <span class="c1"># DenseÏ∏µ ÏßÅÏ†ÑÏóêÎäî ConvÏ∏µÏùÑ FlattenÌïòÎäî Í≤É Î™ÖÏã¨
</span>        <span class="n">self</span><span class="p">.</span><span class="n">input_others</span> <span class="o">=</span> <span class="nc">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># ÌòÑÏû¨ Î∞∞ÌÑ∞Î¶¨ ÎÇ¥ ÏóêÎÑàÏßÄÎüâ
</span>        <span class="n">self</span><span class="p">.</span><span class="n">input_action</span> <span class="o">=</span> <span class="nc">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># action Í∞í
</span>        <span class="n">self</span><span class="p">.</span><span class="n">concat_all</span> <span class="o">=</span> <span class="nf">concatenate</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="n">flatten_conv</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="n">input_others</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="n">input_action</span><span class="p">])</span> 
        <span class="n">self</span><span class="p">.</span><span class="n">hidden_dense_1</span> <span class="o">=</span> <span class="nc">Dense</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">concat_all</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hidden_dense_2</span> <span class="o">=</span> <span class="nc">Dense</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">hidden_dense_1</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">output_qval</span> <span class="o">=</span> <span class="nc">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">hidden_dense_2</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="p">.</span><span class="nc">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">input_load</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="n">input_pv</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="n">input_others</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="n">input_action</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">output_qval</span><span class="p">])</span>     
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">input_load</span><span class="p">,</span><span class="n">input_pv</span><span class="p">,</span><span class="n">input_others</span><span class="p">,</span><span class="n">input_action</span><span class="p">):</span> <span class="c1"># state Îøê ÏïÑÎãàÎùº actionÎèÑ inputÏûÑ        
</span>        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">model</span><span class="p">((</span><span class="n">input_load</span><span class="p">,</span><span class="n">input_pv</span><span class="p">,</span><span class="n">input_others</span><span class="p">,</span><span class="n">input_action</span><span class="p">))</span> <span class="c1"># outputÏùÄ ÏûÖÎ†•Îêú state-action pairÏóê ÎåÄÌïú Q-value 'Îã®ÏùºÍ∞í'
</span>
<span class="k">class</span> <span class="nc">Actor</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span> <span class="c1"># (Continuous) ActionÏùÑ Í≤∞Ï†ïÌïòÎäî policy NN
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">Actor</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span> <span class="c1"># tf.Keras.Model ÏÉÅÏÜçÎ∞õÎäî Ïù¥Ïú†Îäî mainÏΩîÎìúÏóêÏÑú get_weights, set_weights Îì±ÏùÑ Îß§Î≤à model Î©îÏÜåÎìúÎ•º Î∂àÎü¨Ïò§ÏßÄ ÏïäÍ≥†ÎèÑ Ìé∏ÌïòÍ≤å Ïì∞Í∏∞ ÏúÑÌï®          
</span>        <span class="n">self</span><span class="p">.</span><span class="n">input_load</span> <span class="o">=</span> <span class="nc">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">inputlen_load</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># Í≥ºÍ±∞ 12ÏãúÍ∞ÑÏùò Î∂ÄÌïò, shapeÏùò ÎëêÎ≤àÏß∏ Ïà´ÏûêÎäî Ï±ÑÎÑê Ïàò (Ïª¨Îü¨ÏÇ¨ÏßÑÏùò RGB Í∞ôÏùÄ), Ïù¥Í≤å ÏûàÏñ¥Ïïº Conv1DÍ∞Ä ÏûëÎèôÌï®
</span>        <span class="n">self</span><span class="p">.</span><span class="n">input_pv</span> <span class="o">=</span> <span class="nc">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">inputlen_pv</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># Í≥ºÍ±∞ 12ÏãúÍ∞ÑÏùò ÌÉúÏñëÍ¥ëÎ∞úÏ†ÑÎüâ
</span>        <span class="n">self</span><span class="p">.</span><span class="n">hidden_conv_load</span> <span class="o">=</span> <span class="nc">Conv1D</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">input_load</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hidden_conv_pv</span> <span class="o">=</span> <span class="nc">Conv1D</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">input_pv</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">concat_conv</span> <span class="o">=</span> <span class="nf">concatenate</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="n">hidden_conv_load</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="n">hidden_conv_pv</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hidden_conv_concat</span> <span class="o">=</span> <span class="nc">Conv1D</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">concat_conv</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">flatten_conv</span> <span class="o">=</span> <span class="nc">Flatten</span><span class="p">()(</span><span class="n">self</span><span class="p">.</span><span class="n">hidden_conv_concat</span><span class="p">)</span> <span class="c1"># DenseÏ∏µ ÏßÅÏ†ÑÏóêÎäî ConvÏ∏µÏùÑ FlattenÌïòÎäî Í≤É Î™ÖÏã¨
</span>        <span class="n">self</span><span class="p">.</span><span class="n">input_others</span> <span class="o">=</span> <span class="nc">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># ÌòÑÏû¨ Î∞∞ÌÑ∞Î¶¨ ÎÇ¥ ÏóêÎÑàÏßÄÎüâ
</span>        <span class="n">self</span><span class="p">.</span><span class="n">concat_all</span> <span class="o">=</span> <span class="nf">concatenate</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="n">flatten_conv</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="n">input_others</span><span class="p">])</span> 
        <span class="n">self</span><span class="p">.</span><span class="n">hidden_dense_1</span> <span class="o">=</span> <span class="nc">Dense</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">concat_all</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hidden_dense_2</span> <span class="o">=</span> <span class="nc">Dense</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">hidden_dense_1</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">output_action</span> <span class="o">=</span> <span class="nc">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">'tanh'</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">hidden_dense_2</span><span class="p">)</span> <span class="c1"># Node Í∞ØÏàòÎäî actionÏùò ÏûêÏú†ÎèÑÏù¥Î©∞, tanh activationÏùÄ action(Ï∂©/Î∞©Ï†Ñ) Ïù¥ [-c,c] Î≤îÏúÑÏùò bounded actionÏûÑÏùÑ Î∞òÏòÅÌï®
</span>        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="p">.</span><span class="nc">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">input_load</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="n">input_pv</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="n">input_others</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">output_action</span><span class="p">])</span>     
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">input_load</span><span class="p">,</span><span class="n">input_pv</span><span class="p">,</span><span class="n">input_others</span><span class="p">):</span> <span class="c1"># stateÍ∞Ä inputÏûÑ        
</span>        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">model</span><span class="p">((</span><span class="n">input_load</span><span class="p">,</span><span class="n">input_pv</span><span class="p">,</span><span class="n">input_others</span><span class="p">))</span>

<span class="n">critic_one_learning</span> <span class="o">=</span> <span class="nc">Critic</span><span class="p">()</span>
<span class="n">critic_one_target</span> <span class="o">=</span> <span class="nc">Critic</span><span class="p">()</span>
<span class="n">critic_one_learning</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="p">.</span><span class="n">optimizers</span><span class="p">.</span><span class="nc">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">critic_lr</span><span class="p">))</span>
<span class="n">critic_one_target</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="p">.</span><span class="n">optimizers</span><span class="p">.</span><span class="nc">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">critic_lr</span><span class="p">))</span>
<span class="n">critic_one_target</span><span class="p">.</span><span class="nf">set_weights</span><span class="p">(</span><span class="n">critic_one_learning</span><span class="p">.</span><span class="nf">get_weights</span><span class="p">())</span> <span class="c1"># target netÏùò Í∞ÄÏ§ëÏπòÎ•º learning netÏùò Í∞ÄÏ§ëÏπòÏôÄ Í∞ôÍ≤å Ï¥àÍ∏∞Ìôî
</span>
<span class="n">critic_two_learning</span> <span class="o">=</span> <span class="nc">Critic</span><span class="p">()</span>
<span class="n">critic_two_target</span> <span class="o">=</span> <span class="nc">Critic</span><span class="p">()</span>
<span class="n">critic_two_learning</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="p">.</span><span class="n">optimizers</span><span class="p">.</span><span class="nc">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">critic_lr</span><span class="p">))</span>
<span class="n">critic_two_target</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="p">.</span><span class="n">optimizers</span><span class="p">.</span><span class="nc">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">critic_lr</span><span class="p">))</span>
<span class="n">critic_two_target</span><span class="p">.</span><span class="nf">set_weights</span><span class="p">(</span><span class="n">critic_two_learning</span><span class="p">.</span><span class="nf">get_weights</span><span class="p">())</span> <span class="c1"># target netÏùò Í∞ÄÏ§ëÏπòÎ•º learning netÏùò Í∞ÄÏ§ëÏπòÏôÄ Í∞ôÍ≤å Ï¥àÍ∏∞Ìôî
</span>
<span class="n">actor_learning</span> <span class="o">=</span> <span class="nc">Actor</span><span class="p">()</span>
<span class="n">actor_target</span> <span class="o">=</span> <span class="nc">Actor</span><span class="p">()</span>
<span class="n">actor_learning</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="p">.</span><span class="n">optimizers</span><span class="p">.</span><span class="nc">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">actor_lr</span><span class="p">))</span>
<span class="n">actor_target</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="p">.</span><span class="n">optimizers</span><span class="p">.</span><span class="nc">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">actor_lr</span><span class="p">))</span>
<span class="n">actor_target</span><span class="p">.</span><span class="nf">set_weights</span><span class="p">(</span><span class="n">actor_learning</span><span class="p">.</span><span class="nf">get_weights</span><span class="p">())</span> <span class="c1"># target netÏùò Í∞ÄÏ§ëÏπòÎ•º learning netÏùò Í∞ÄÏ§ëÏπòÏôÄ Í∞ôÍ≤å Ï¥àÍ∏∞Ìôî
</span>



<span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="n">replay_buffer</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sample_experiences</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span> <span class="c1"># batch_sizeÎßåÌÅºÏùò Í≤ΩÌóòÎì§Ïùò stateÎì§, actionÎì§, rewardÎì§, nextstateÎì§, doneÎì§Ïùò Î¶¨Ïä§Ìä∏Îì§ÏùÑ Î∞òÌôò
</span>    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">replay_buffer</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span> <span class="c1"># replay buffer ÎÇ¥ Í≤ΩÌóòÎì§ Ï§ë ÎûúÎç§ÌïòÍ≤å batch_sizeÎßåÌÅºÏùò Í≤ΩÌóòÎì§ÏùÑ ÏßÄÏ†ï (Ïù∏Îç±Ïä§ Î∂àÎü¨Ïò¥)
</span>    <span class="n">batch</span> <span class="o">=</span> <span class="p">[</span><span class="n">replay_buffer</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span> <span class="c1"># ÏúÑÏóêÏÑú Î∂àÎü¨Ïò® Ïù∏Îç±Ïä§Î•º Ïù¥Ïö©Ìï¥ batch_size ÎßåÌÅºÏùò Í≤ΩÌóòÎì§ÏùÑ batch Î¶¨Ïä§Ìä∏Ïóê Îã¥Ïùå
</span>    <span class="n">states</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">next_states</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">experience</span><span class="p">[</span><span class="n">field_index</span><span class="p">]</span> <span class="k">for</span> <span class="n">experience</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">])</span> <span class="c1"># ÌïòÎÇòÏùò array ÏïàÏóê batch ÎÇ¥ Í∞Å Í≤ΩÌóòÎ≥Ñ Í∞íÎì§Ïù¥ Îì§Ïñ¥Í∞ê 
</span>        <span class="k">for</span> <span class="n">field_index</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span> <span class="c1"># Ï¥ù 5Í∞úÏùò arrayÎ•º Î∞òÌôò, Í∞ÅÍ∞ÅÏùÄ (batch ÎÇ¥ sampleÍ≤ΩÌóòÎì§Ïùò) stateÎì§, actionÎì§, rewardÎì§, nextstateÎì§, doneÎì§Ïùò Î¶¨Ïä§Ìä∏ÏûÑ
</span>    <span class="k">return</span> <span class="n">states</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">next_states</span>



<span class="c1"># def noise(epsilon): # ExplorationÏùÑ ÏúÑÌïú noise 
#     # ‚òÖ‚òÖ‚òÖ ÎÇ¥ actionÏù¥ boundedÏûÑÏùÑ Í≥†Î†§Ìï¥ÏÑú Ïûò Íµ¨ÏÑ±Ìï† Í≤É
#     return np.random.normal(0,epsilon) 
</span>
<span class="k">def</span> <span class="nf">play_one_step</span><span class="p">(</span><span class="n">profile_load</span><span class="p">,</span><span class="n">profile_pv</span><span class="p">,</span><span class="n">hour</span><span class="p">,</span><span class="n">energy_batt</span><span class="p">,</span><span class="n">epsilon</span><span class="p">,</span><span class="n">training</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        
    <span class="n">state</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">profile_load</span><span class="p">[</span><span class="n">hour</span><span class="o">-</span><span class="n">inputlen_load</span><span class="p">:</span><span class="n">hour</span><span class="p">],</span> <span class="n">profile_pv</span><span class="p">[</span><span class="n">hour</span><span class="o">-</span><span class="n">inputlen_pv</span><span class="p">:</span><span class="n">hour</span><span class="p">],</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">energy_batt</span><span class="p">]))</span> <span class="p">)</span>
     
    <span class="c1"># profile_load = load_train #(ÏΩîÎìú ÏûòÎèÑÎäîÏßÄ ÌÖåÏä§Ìä∏Ïö©)
</span>    <span class="c1"># profile_pv = PV_prod_train #(ÏΩîÎìú ÏûòÎèÑÎäîÏßÄ ÌÖåÏä§Ìä∏Ïö©)
</span>    <span class="c1"># energy_batt = initialenergy_batt #(ÏΩîÎìú ÏûòÎèÑÎäîÏßÄ ÌÖåÏä§Ìä∏Ïö©)
</span>    
    <span class="k">if</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">epsilon</span> <span class="ow">and</span> <span class="n">training</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span> <span class="c1"># exploration during training
</span>        <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># exploration Ïãú -1~+1 ÏÇ¨Ïù¥Ïùò Ïã§ÏàòÎ•º Í∑†Îì±Î∂ÑÌè¨ÏóêÏÑú Ï∂îÏ∂ú
</span>    <span class="k">else</span><span class="p">:</span> <span class="c1"># exploitation
</span>        <span class="n">action</span> <span class="o">=</span> <span class="nf">actor_learning</span><span class="p">(</span><span class="n">profile_load</span><span class="p">[</span><span class="n">hour</span><span class="o">-</span><span class="n">inputlen_load</span><span class="p">:</span><span class="n">hour</span><span class="p">].</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">inputlen_load</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">profile_pv</span><span class="p">[</span><span class="n">hour</span><span class="o">-</span><span class="n">inputlen_pv</span><span class="p">:</span><span class="n">hour</span><span class="p">].</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">inputlen_pv</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">energy_batt</span><span class="p">]).</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)).</span><span class="nf">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># action netÏùò outputÏùÄ tensorÏù¥ÎØÄÎ°ú Ïù¥Î•º numpy Î≥ÄÌôò ÌõÑ [0][0] Î∂ôÏó¨ÏÑú Îã®Ïàú intÎ°ú ÎßåÎì¶
</span>    
    <span class="c1"># Unscaling
</span>    <span class="n">p_h2_send</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">p_h2_receive</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">action</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">p_h2_receive</span> <span class="o">=</span> <span class="n">prate_h2</span><span class="o">*</span><span class="n">action</span> <span class="c1"># Ïó¨Í∏∞ÏÑúÎäî ÏàòÏÜåÎ°ú ÏÉùÏÇ∞Îêú Ï†ÑÍ∏∞Î•º 'Î∞õÏùÑ Îïå' ÏñëÏàòÎùºÍ≥† Í∞ÄÏ†ï
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="n">p_h2_send</span> <span class="o">=</span> <span class="o">-</span><span class="n">prate_h2</span><span class="o">*</span><span class="n">action</span> <span class="c1"># prate_h2Î•º Í≥±Ìï¥Ï£ºÎäî Í≤ÉÏùÄ unscalingÏúºÎ°ú Î≥º Ïàò ÏûàÏùå
</span>    <span class="n">p_load</span> <span class="o">=</span> <span class="n">profile_load</span><span class="p">[</span><span class="n">hour</span><span class="p">]</span><span class="o">*</span><span class="n">load_peak</span> <span class="c1"># ÌòÑÏû¨ ÏãúÍ∞ÑÏùò Î∂ÄÌïò (action Í≤∞Ï†ï Í∏∞Ï§ÄÏù¥ ÏïÑÎãò!), ÏûÖÎ†•ÏûêÎ£åÍ∞Ä [0,1]Î°ú scaledÎêú Í±∏ unscalingÌï®
</span>    <span class="n">p_pv</span> <span class="o">=</span> <span class="n">profile_pv</span><span class="p">[</span><span class="n">hour</span><span class="p">]</span><span class="o">*</span><span class="n">pv_peak</span> <span class="c1"># ÌòÑÏû¨ ÏãúÍ∞ÑÏùò Î∞úÏ†ÑÎüâ (action Í≤∞Ï†ï Í∏∞Ï§ÄÏù¥ ÏïÑÎãò!), ÏûÖÎ†•ÏûêÎ£åÍ∞Ä [0,1]Î°ú scaledÎêú Í±∏ unscalingÌï®  
</span>    <span class="n">energy_batt</span> <span class="o">=</span> <span class="n">energy_batt</span><span class="o">*</span><span class="n">capa_batt</span> <span class="c1"># unscaling
</span>    
    
    <span class="c1">#p_curtail = 0
</span>    <span class="n">p_loss</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="n">p_net_beforebatt</span> <span class="o">=</span> <span class="n">p_pv</span> <span class="o">-</span> <span class="n">p_load</span> <span class="o">+</span> <span class="n">p_h2_receive</span> <span class="o">-</span> <span class="n">p_h2_send</span> <span class="c1"># ÌÉúÏñëÍ¥ë ÏÉùÏÇ∞, Î∂ÄÌïò Ï∂©Ï°±, H2 Î≥¥ÎÇ¥Í±∞ÎÇò Î∞õÏùÄ ÌõÑ ÏàòÏö©Í∞Ä ÏûÖÏû•ÏóêÏÑú Ï†ÑÍ∏∞ÏóêÎÑàÏßÄÍ∞Ä ÎÇ®ÏúºÎ©¥ ÏñëÏàò, Î∂ÄÏ°±ÌïòÎ©¥ ÏùåÏàò
</span>    
    <span class="k">if</span> <span class="n">p_net_beforebatt</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Ï†ÑÍ∏∞ÏóêÎÑàÏßÄÍ∞Ä ÎÇ®ÏúºÎØÄÎ°ú Î∞∞ÌÑ∞Î¶¨Ïóê Ï†ÄÏû•ÌïòÍ≥†, ÎßåÏïΩ Î∞∞ÌÑ∞Î¶¨ÎèÑ ÍΩâ Ï∞¨Îã§Î©¥ curtailÌï®
</span>        <span class="k">if</span> <span class="n">capa_batt</span> <span class="o">&gt;=</span> <span class="n">energy_batt</span> <span class="o">+</span> <span class="n">p_net_beforebatt</span><span class="o">*</span><span class="n">eff_batt</span><span class="p">:</span> <span class="c1"># Î∞∞ÌÑ∞Î¶¨Ïóê ÏûîÏó¨ Ï∂©Ï†Ñ Í∞ÄÎä•Ìïú ÏóêÎÑàÏßÄÍ∞Ä ÏúÑÏóêÏÑú ÎÇ®ÏùÄ ÏóêÎÑàÏßÄ(ÏóêÏÑú Î≥ÄÌôòÏÜêÏã§ Ï†úÌïú ÏóêÎÑàÏßÄ) Ïù¥ÏÉÅÏùº Í≤ΩÏö∞
</span>            <span class="n">energy_batt_after</span> <span class="o">=</span> <span class="n">energy_batt</span> <span class="o">+</span> <span class="n">p_net_beforebatt</span><span class="o">*</span><span class="n">eff_batt</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># ÎÇ®ÏùÄ ÏóêÎÑàÏßÄÎ•º Î∞∞ÌÑ∞Î¶¨Ïóê Îã§ Ï∂©Ï†ÑÌïòÎ©¥ ÍΩâ Ï∞®Í≥†ÎèÑ ÎÇ®ÏïÑÏÑú, curtailÌï¥Ïïº Ìï®
</span>            <span class="n">energy_batt_after</span> <span class="o">=</span> <span class="n">capa_batt</span>
            <span class="c1"># p_curtail = (energy_batt + p_net_beforebatt*eff_batt - capa_batt)/eff_batt # Í¥ÑÌò∏ ÏïàÏùÄ Î∞∞ÌÑ∞Î¶¨ ÎÇ¥Î∂Ä Í∏∞Ï§ÄÏù¥Î©∞, ÏàòÏö©Í∞Ä Î™®ÏÑ† Í∏∞Ï§Ä ÏñëÏùÑ Íµ¨ÌïòÎ†§Î©¥ eff_battÎ°ú ÎÇòÎà†Ï§òÏïº Ìï®
</span>    <span class="k">else</span><span class="p">:</span> <span class="c1"># Ï†ÑÍ∏∞ÏóêÎÑàÏßÄÍ∞Ä Î∂ÄÏ°±ÌïòÎØÄÎ°ú Î∞∞ÌÑ∞Î¶¨ ÏóêÎÑàÏßÄÎ•º Ïç®Ïïº Ìï®, Î∞∞ÌÑ∞Î¶¨ ÏóêÎÑàÏßÄÎ°úÎèÑ Î∂ÄÏ°±ÌïòÎ©¥ lossÏûÑ
</span>        <span class="k">if</span> <span class="n">energy_batt</span><span class="o">*</span><span class="n">eff_batt</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">p_net_beforebatt</span><span class="p">:</span> <span class="c1"># Î∞∞ÌÑ∞Î¶¨ ÏóêÎÑàÏßÄÎ°ú Ï∂©Îãπ Í∞ÄÎä•Ìïú Í≤ΩÏö∞
</span>            <span class="n">energy_batt_after</span> <span class="o">=</span> <span class="n">energy_batt</span> <span class="o">+</span> <span class="n">p_net_beforebatt</span><span class="o">/</span><span class="n">eff_batt</span> <span class="c1"># p_net_beforebattÍ∞Ä ÏùåÏàòÏù¥ÎØÄÎ°ú ÎßàÏù¥ÎÑàÏä§Í∞íÏù¥ Î∂ÄÏ°±Ìïú ÏóêÎÑàÏßÄ'Îüâ'Ïù¥Í≥† Í∑∏Í±∏ 'Îπº'ÎØÄÎ°ú Í≤∞Í≥ºÏ†ÅÏúºÎ°ú ÌîåÎü¨Ïä§
</span>        <span class="k">else</span><span class="p">:</span> <span class="c1"># Î∂ÄÏ°±Ìï¥ loss Î∞úÏÉù
</span>            <span class="n">energy_batt_after</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">p_loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">p_net_beforebatt</span> <span class="o">-</span> <span class="n">energy_batt</span><span class="o">*</span><span class="n">eff_batt</span>           
    
    <span class="n">reward</span> <span class="o">=</span> <span class="n">price_h2</span><span class="o">*</span><span class="n">p_h2_send</span><span class="o">*</span><span class="n">eff_h2</span> <span class="o">-</span> <span class="n">price_h2</span><span class="o">*</span><span class="n">p_h2_receive</span><span class="o">/</span><span class="n">eff_h2</span> <span class="o">-</span> <span class="n">cost_loss</span><span class="o">*</span><span class="n">p_loss</span> <span class="c1"># rewardÎèÑ scalingÌï®
</span>    <span class="n">energy_batt_after</span> <span class="o">=</span> <span class="n">energy_batt_after</span><span class="o">/</span><span class="n">capa_batt</span> <span class="c1"># Î∞∞ÌÑ∞Î¶¨ ÎÇ¥ Ï†ÄÏû•ÎüâÏùÑ [0,1] Î≤îÏúÑÎ°ú scalingÌï®
</span>    
    <span class="k">if</span> <span class="n">training</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">next_state</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">profile_load</span><span class="p">[</span><span class="n">hour</span><span class="o">-</span><span class="p">(</span><span class="n">inputlen_load</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span><span class="n">hour</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">profile_pv</span><span class="p">[</span><span class="n">hour</span><span class="o">-</span><span class="p">(</span><span class="n">inputlen_pv</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span><span class="n">hour</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">energy_batt_after</span><span class="p">]))</span> <span class="p">)</span>         
        <span class="n">replay_buffer</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reward</span><span class="o">*</span><span class="n">rewardscalefactor</span><span class="p">,</span> <span class="n">next_state</span><span class="p">))</span> <span class="c1"># tupleÏùÑ appendÌï®Ïóê Ï£ºÏùò
</span>    <span class="k">return</span> <span class="n">energy_batt_after</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">action</span>



<span class="k">def</span> <span class="nf">training_step</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span><span class="n">actorupdate</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    
    <span class="n">states</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">next_states</span> <span class="o">=</span> <span class="nf">sample_experiences</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
        
    <span class="n">input_load</span> <span class="o">=</span> <span class="n">states</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">inputlen_load</span><span class="p">].</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">inputlen_load</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> 
    <span class="n">input_pv</span> <span class="o">=</span> <span class="n">states</span><span class="p">[:,</span><span class="n">inputlen_load</span><span class="p">:(</span><span class="n">inputlen_load</span><span class="o">+</span><span class="n">inputlen_pv</span><span class="p">)].</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">inputlen_pv</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">input_others</span> <span class="o">=</span> <span class="n">states</span><span class="p">[:,(</span><span class="n">inputlen_load</span><span class="o">+</span><span class="n">inputlen_pv</span><span class="p">)].</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">input_load_next</span> <span class="o">=</span> <span class="n">next_states</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">inputlen_load</span><span class="p">].</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">inputlen_load</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">input_pv_next</span> <span class="o">=</span> <span class="n">next_states</span><span class="p">[:,</span><span class="n">inputlen_load</span><span class="p">:(</span><span class="n">inputlen_load</span><span class="o">+</span><span class="n">inputlen_pv</span><span class="p">)].</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">inputlen_pv</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">input_others_next</span> <span class="o">=</span> <span class="n">next_states</span><span class="p">[:,(</span><span class="n">inputlen_load</span><span class="o">+</span><span class="n">inputlen_pv</span><span class="p">)].</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">clippednoise_std</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="o">-</span><span class="n">clippednoise_interval</span><span class="p">,</span> <span class="n">clippednoise_interval</span><span class="p">)</span> <span class="c1"># NoiseÎ•º ÌäπÏ†ï Î≤îÏúÑÎ°ú clip (Î≤îÏúÑ ÏÑ§Ï†ïÏùÄ hyperparameter)
</span>    <span class="n">actions_by_target</span> <span class="o">=</span> <span class="nf">actor_target</span><span class="p">(</span><span class="n">input_load_next</span><span class="p">,</span><span class="n">input_pv_next</span><span class="p">,</span><span class="n">input_others_next</span><span class="p">).</span><span class="nf">numpy</span><span class="p">().</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">noise</span> <span class="c1"># gradsÍ∞Ä ÏÉùÍ∏∞ÎèÑÎ°ù GradientTape Íµ¨Î¨∏ ÎÇ¥ÏóêÏÑú model ouput TensorÎ•º Îã§Ïãú Î∂àÎü¨Ïò¥
</span>    <span class="n">actions_by_target</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">actions_by_target</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># noise Ï∂îÍ∞ÄÌïòÍ≥† ÎÇòÏÑúÎèÑ actionÏù¥ -1ÏóêÏÑú +1 ÏÇ¨Ïù¥Î°ú Îì§Ïñ¥Ïò§ÎèÑÎ°ù Ìï®
</span>    
    <span class="n">Q_values_one_by_target</span> <span class="o">=</span> <span class="nf">critic_one_target</span><span class="p">(</span><span class="n">input_load_next</span><span class="p">,</span><span class="n">input_pv_next</span><span class="p">,</span><span class="n">input_others_next</span><span class="p">,</span><span class="n">actions_by_target</span><span class="p">)</span>
    <span class="n">Q_values_two_by_target</span> <span class="o">=</span> <span class="nf">critic_two_target</span><span class="p">(</span><span class="n">input_load_next</span><span class="p">,</span><span class="n">input_pv_next</span><span class="p">,</span><span class="n">input_others_next</span><span class="p">,</span><span class="n">actions_by_target</span><span class="p">)</span>
    <span class="n">Q_values_min_by_target</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="nf">minimum</span><span class="p">(</span><span class="n">Q_values_one_by_target</span><span class="p">,</span> <span class="n">Q_values_two_by_target</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="nf">stop_gradient</span><span class="p">(</span><span class="n">rewards</span> <span class="o">+</span> <span class="n">discount_factor</span> <span class="o">*</span> <span class="n">Q_values_min_by_target</span><span class="p">)</span>
    
    <span class="k">with</span> <span class="n">tf</span><span class="p">.</span><span class="nc">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span> <span class="c1"># critic net ÏóÖÎç∞Ïù¥Ìä∏Î•º ÏúÑÌïú ÏûêÎèôÎØ∏Î∂Ñ (actor net ÏóÖÎç∞Ïù¥Ìä∏ÏôÄ Î≥ÑÍ∞úÎ°ú Îë†)        
</span>        <span class="n">Q_values_one</span> <span class="o">=</span> <span class="nf">critic_one_learning</span><span class="p">(</span><span class="n">input_load</span><span class="p">,</span><span class="n">input_pv</span><span class="p">,</span><span class="n">input_others</span><span class="p">,</span><span class="n">actions</span><span class="p">.</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># ÏõêÎûò critic Ïã†Í≤ΩÎßù Ìï≠ÏóêÎäî Ïã§Ï†úÎ°ú ÌñâÌñàÎçò actionsÎ•º ÎÑ£Ïñ¥Ïïº Ìï® (noise Ìè¨Ìï®ÌïòÎäî) 
</span>        <span class="n">loss_critic_one</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="nf">reduce_mean</span><span class="p">(</span><span class="n">keras</span><span class="p">.</span><span class="n">losses</span><span class="p">.</span><span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">Q_values_one</span><span class="p">))</span> <span class="c1"># ÌèâÍ∑†Ï†úÍ≥±Ïò§Ï∞® Í≥ÑÏÇ∞
</span>    <span class="n">grads</span> <span class="o">=</span> <span class="n">tape</span><span class="p">.</span><span class="nf">gradient</span><span class="p">(</span><span class="n">loss_critic_one</span><span class="p">,</span> <span class="n">critic_one_learning</span><span class="p">.</span><span class="n">trainable_variables</span><span class="p">)</span> <span class="c1"># loss Ìï®ÏàòÎ•º modelÏùò trainable variabbles Ï†ÑÏ≤¥Ïóê ÎåÄÌï¥ ÎØ∏Î∂Ñ
</span>    <span class="n">critic_one_learning</span><span class="p">.</span><span class="n">optimizer</span><span class="p">.</span><span class="nf">apply_gradients</span><span class="p">(</span><span class="nf">zip</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="n">critic_one_learning</span><span class="p">.</span><span class="n">trainable_variables</span><span class="p">))</span> <span class="c1"># Adam optimizerÎ°ú parameter update ÏàòÌñâ, zipÏúºÎ°ú gradientÏôÄ parameter pairÎ•º ÎßûÏ∂∞Ï§å    
</span>    
    <span class="k">with</span> <span class="n">tf</span><span class="p">.</span><span class="nc">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span> <span class="c1"># critic net ÏóÖÎç∞Ïù¥Ìä∏Î•º ÏúÑÌïú ÏûêÎèôÎØ∏Î∂Ñ (actor net ÏóÖÎç∞Ïù¥Ìä∏ÏôÄ Î≥ÑÍ∞úÎ°ú Îë†)        
</span>        <span class="n">Q_values_two</span> <span class="o">=</span> <span class="nf">critic_two_learning</span><span class="p">(</span><span class="n">input_load</span><span class="p">,</span><span class="n">input_pv</span><span class="p">,</span><span class="n">input_others</span><span class="p">,</span><span class="n">actions</span><span class="p">.</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># ÏõêÎûò critic Ïã†Í≤ΩÎßù Ìï≠ÏóêÎäî Ïã§Ï†úÎ°ú ÌñâÌñàÎçò actionsÎ•º ÎÑ£Ïñ¥Ïïº Ìï® (noise Ìè¨Ìï®ÌïòÎäî) 
</span>        <span class="n">loss_critic_two</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="nf">reduce_mean</span><span class="p">(</span><span class="n">keras</span><span class="p">.</span><span class="n">losses</span><span class="p">.</span><span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">Q_values_two</span><span class="p">))</span> <span class="c1"># ÌèâÍ∑†Ï†úÍ≥±Ïò§Ï∞® Í≥ÑÏÇ∞
</span>    <span class="n">grads</span> <span class="o">=</span> <span class="n">tape</span><span class="p">.</span><span class="nf">gradient</span><span class="p">(</span><span class="n">loss_critic_two</span><span class="p">,</span> <span class="n">critic_two_learning</span><span class="p">.</span><span class="n">trainable_variables</span><span class="p">)</span> <span class="c1"># loss Ìï®ÏàòÎ•º modelÏùò trainable variabbles Ï†ÑÏ≤¥Ïóê ÎåÄÌï¥ ÎØ∏Î∂Ñ
</span>    <span class="n">critic_two_learning</span><span class="p">.</span><span class="n">optimizer</span><span class="p">.</span><span class="nf">apply_gradients</span><span class="p">(</span><span class="nf">zip</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="n">critic_two_learning</span><span class="p">.</span><span class="n">trainable_variables</span><span class="p">))</span> <span class="c1"># Adam optimizerÎ°ú parameter update ÏàòÌñâ, zipÏúºÎ°ú gradientÏôÄ parameter pairÎ•º ÎßûÏ∂∞Ï§å    
</span>    
    <span class="k">if</span> <span class="n">actorupdate</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>    
        <span class="k">with</span> <span class="n">tf</span><span class="p">.</span><span class="nc">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span> <span class="c1"># actor net ÏóÖÎç∞Ïù¥Ìä∏Î•º ÏúÑÌïú ÏûêÎèôÎØ∏Î∂Ñ (critic net ÏóÖÎç∞Ïù¥Ìä∏ÏôÄ Î≥ÑÍ∞úÎ°ú Îë†)  
</span>            <span class="n">actions_by_learner</span> <span class="o">=</span> <span class="nf">actor_learning</span><span class="p">(</span><span class="n">input_load</span><span class="p">,</span><span class="n">input_pv</span><span class="p">,</span><span class="n">input_others</span><span class="p">)</span> <span class="c1"># gradsÍ∞Ä ÏÉùÍ∏∞ÎèÑÎ°ù GradientTape Íµ¨Î¨∏ ÎÇ¥ÏóêÏÑú model ouput TensorÎ•º Îã§Ïãú Î∂àÎü¨Ïò¥
</span>            <span class="n">Q_values_one</span> <span class="o">=</span> <span class="nf">critic_one_learning</span><span class="p">(</span><span class="n">input_load</span><span class="p">,</span><span class="n">input_pv</span><span class="p">,</span><span class="n">input_others</span><span class="p">,</span><span class="n">actions_by_learner</span><span class="p">)</span> <span class="c1"># actorÏóê ÎåÄÌïú ÎØ∏Î∂ÑÏù¥ÎØÄÎ°ú actions_by_learnerÎ•º numpyÎ°ú Î∞îÍæ∏ÏßÄ ÏïäÍ≥† TensorÎ°ú Í∑∏ÎåÄÎ°ú ÎëêÏñ¥Ïïº Ìï®
</span>            <span class="n">Q_values_two</span> <span class="o">=</span> <span class="nf">critic_two_learning</span><span class="p">(</span><span class="n">input_load</span><span class="p">,</span><span class="n">input_pv</span><span class="p">,</span><span class="n">input_others</span><span class="p">,</span><span class="n">actions_by_learner</span><span class="p">)</span> <span class="c1"># actorÏóê ÎåÄÌïú ÎØ∏Î∂ÑÏù¥ÎØÄÎ°ú actions_by_learnerÎ•º numpyÎ°ú Î∞îÍæ∏ÏßÄ ÏïäÍ≥† TensorÎ°ú Í∑∏ÎåÄÎ°ú ÎëêÏñ¥Ïïº Ìï®
</span>            <span class="n">Q_values_min</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="nf">minimum</span><span class="p">(</span><span class="n">Q_values_one</span><span class="p">,</span> <span class="n">Q_values_two</span><span class="p">)</span> <span class="c1"># GradientÍ∞Ä Î∂ôÏñ¥Ïïº ÌïòÎØÄÎ°ú np.minimumÏù¥ ÏïÑÎãàÎùº tf.math.minimumÏûÑÏóê Ï£ºÏùò
</span>            <span class="n">loss_actor</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="nf">reduce_mean</span><span class="p">(</span><span class="o">-</span><span class="n">Q_values_min</span><span class="p">)</span> <span class="c1"># ÏùåÏùò Q-value ÏµúÏÜåÌôî, Ï¶â Q-valueÎ•º ÏµúÎåÄÌôîÌïòÎèÑÎ°ù actorÎ•º ÏóÖÎç∞Ïù¥Ìä∏Ìï®
</span>        <span class="n">grads</span> <span class="o">=</span> <span class="n">tape</span><span class="p">.</span><span class="nf">gradient</span><span class="p">(</span><span class="n">loss_actor</span><span class="p">,</span> <span class="n">actor_learning</span><span class="p">.</span><span class="n">trainable_variables</span><span class="p">)</span> <span class="c1"># loss Ìï®ÏàòÎ•º modelÏùò trainable variabbles Ï†ÑÏ≤¥Ïóê ÎåÄÌï¥ ÎØ∏Î∂Ñ
</span>        <span class="n">actor_learning</span><span class="p">.</span><span class="n">optimizer</span><span class="p">.</span><span class="nf">apply_gradients</span><span class="p">(</span><span class="nf">zip</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="n">actor_learning</span><span class="p">.</span><span class="n">trainable_variables</span><span class="p">))</span> <span class="c1"># Adam optimizerÎ°ú parameter update ÏàòÌñâ, zipÏúºÎ°ú gradientÏôÄ parameter pairÎ•º ÎßûÏ∂∞Ï§å
</span>        
        <span class="n">actor_weights</span> <span class="o">=</span> <span class="n">actor_learning</span><span class="p">.</span><span class="n">weights</span> <span class="c1"># ÏõêÎûò netÏùò weight Î∂àÎü¨Ïò¥ (Ïó∞ÏÇ∞ÏùÑ ÏúÑÌï¥)
</span>        <span class="n">target_actor_weights</span> <span class="o">=</span> <span class="n">actor_target</span><span class="p">.</span><span class="n">weights</span> <span class="c1"># target netÏùò weight Î∂àÎü¨Ïò¥
</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">actor_weights</span><span class="p">)):</span> <span class="c1"># Ïù¥Î†áÍ≤å ÌïòÎÇòÌïòÎÇò Ìï¥Ïïº ÎêòÎÇò?
</span>            <span class="n">target_actor_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">*</span> <span class="n">actor_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">tau</span><span class="p">)</span> <span class="o">*</span> <span class="n">target_actor_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">actor_target</span><span class="p">.</span><span class="nf">set_weights</span><span class="p">(</span><span class="n">target_actor_weights</span><span class="p">)</span> <span class="c1"># Ïù¥Í±∞ ÍπåÎ®πÏßÄ Îßê Í≤É!
</span>        
        <span class="n">critic_one_weights</span> <span class="o">=</span> <span class="n">critic_one_learning</span><span class="p">.</span><span class="n">weights</span> <span class="c1"># ÏõêÎûò netÏùò weight Î∂àÎü¨Ïò¥ (Ïó∞ÏÇ∞ÏùÑ ÏúÑÌï¥)
</span>        <span class="n">critic_two_weights</span> <span class="o">=</span> <span class="n">critic_two_learning</span><span class="p">.</span><span class="n">weights</span> <span class="c1"># ÏõêÎûò netÏùò weight Î∂àÎü¨Ïò¥ (Ïó∞ÏÇ∞ÏùÑ ÏúÑÌï¥)
</span>        <span class="n">target_critic_one_weights</span> <span class="o">=</span> <span class="n">critic_one_target</span><span class="p">.</span><span class="n">weights</span> <span class="c1"># target netÏùò weight Î∂àÎü¨Ïò¥
</span>        <span class="n">target_critic_two_weights</span> <span class="o">=</span> <span class="n">critic_two_target</span><span class="p">.</span><span class="n">weights</span> <span class="c1"># target netÏùò weight Î∂àÎü¨Ïò¥
</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">critic_one_weights</span><span class="p">)):</span> <span class="c1"># Ïù¥Î†áÍ≤å ÌïòÎÇòÌïòÎÇò Ìï¥Ïïº ÎêòÎÇò?
</span>            <span class="n">target_critic_one_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">*</span> <span class="n">critic_one_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">tau</span><span class="p">)</span> <span class="o">*</span> <span class="n">target_critic_one_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">target_critic_two_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">*</span> <span class="n">critic_two_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">tau</span><span class="p">)</span> <span class="o">*</span> <span class="n">target_critic_two_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">critic_one_target</span><span class="p">.</span><span class="nf">set_weights</span><span class="p">(</span><span class="n">target_critic_one_weights</span><span class="p">)</span> <span class="c1"># Ïù¥Í±∞ ÍπåÎ®πÏßÄ Îßê Í≤É!    
</span>        <span class="n">critic_two_target</span><span class="p">.</span><span class="nf">set_weights</span><span class="p">(</span><span class="n">target_critic_two_weights</span><span class="p">)</span> <span class="c1"># Ïù¥Í±∞ ÍπåÎ®πÏßÄ Îßê Í≤É!    
</span>




<span class="n">profits_test</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">elapsedtime_test</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">max_return_test</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">inf</span>
<span class="n">count_step_fortrain</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">bool_fortrain</span> <span class="o">=</span> <span class="bp">False</span>


<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span> <span class="c1"># Ïã§Ï†úÎ°úÎäî termination stateÍ∞Ä ÏóÜÎäî taskÏù∏Îç∞... epochÎ≥¥Îã® epochÍ∞Ä Îçî ÏûêÏó∞Ïä§Îü¨Ïö¥ ÌëúÌòÑÏùº ÎìØ?
</span>    <span class="k">if</span> <span class="n">epoch</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Îß® Ï≤´ Î≤àÏß∏ epochÏóêÏÑúÎäî ÌõàÎ†®ÏùÑ ÏãúÏûëÌïòÏßÄ ÏïäÍ≥† bufferÎ•º Ï±ÑÏõÄ, Îëê Î≤àÏß∏ epochÎ∂ÄÌÑ∞Îäî bufferÏóê sampleÎì§Ïù¥ Ï±ÑÏõåÏ°åÏúºÎØÄÎ°ú ÌõàÎ†®Ìï®
</span>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    
    <span class="c1">### Train for each epoch
</span>    
    <span class="n">hour</span> <span class="o">=</span> <span class="mi">24</span> <span class="c1"># ÏãúÏûëÏãúÏ†ê
</span>    <span class="n">energy_batt</span> <span class="o">=</span> <span class="n">initialenergy_batt</span>  
    
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">load_train</span><span class="p">)</span><span class="o">-</span><span class="mi">25</span><span class="p">):</span> <span class="c1"># Îç∞Ïù¥ÌÑ∞ ÎÇ¥Ïùò ÎßàÏßÄÎßâ ÏãúÏ†êÏù¥ nextstateÏóêÎßå Ìè¨Ìï®Îê† ÎïåÍπåÏßÄ (ÎåÄÏã† termination stateÎäî Îî∞Î°ú ÏóÜÏùå)
</span>        <span class="n">count_step_fortrain</span> <span class="o">+=</span> <span class="mi">1</span>  
        <span class="n">epsilon</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">epoch</span> <span class="o">/</span> <span class="mi">50</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span> <span class="c1"># epsilonÏùÑ 1ÏóêÏÑú 0.01ÍπåÏßÄ ÏÑ†ÌòïÏ†ÅÏúºÎ°ú Ï§ÑÏûÑ, Ïù¥ Í≤ΩÏö∞ Í∑πÏ¥àÎ∞òÏóêÎäî Í±∞Ïùò Îã§ explorationÏù¥ÎØÄÎ°ú Ìïú epochÍ∞Ä Îß§Ïö∞ Îπ®Î¶¨ Í≥ÑÏÇ∞ÎêòÎÇò, Ï§ëÎ∞òÏùÑ ÎÑòÏñ¥Í∞ÄÎ©¥ Í±∞Ïùò exploitationÏù¥Î©∞ Ïù¥ Îïå Îß§ stepÎßàÎã§ NNÏùÑ callÌïòÎØÄÎ°ú ÎäêÎ†§Ïßê
</span>        <span class="n">energy_batt</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="nf">play_one_step</span><span class="p">(</span><span class="n">load_train</span><span class="p">,</span><span class="n">PV_prod_train</span><span class="p">,</span><span class="n">hour</span><span class="p">,</span><span class="n">energy_batt</span><span class="p">,</span><span class="n">epsilon</span><span class="p">,</span><span class="n">training</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1"># obsÍ∞Ä Î∞òÎ≥µ Í∞±Ïã†Îê®
</span>        <span class="n">hour</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># ÏãúÍ∞ÑÏùò ÌùêÎ¶Ñ Î∞òÏòÅ      
</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">count_step_fortrain</span> <span class="o">&gt;</span> <span class="n">period_step_fortrain</span><span class="p">:</span> 
                <span class="nf">training_step</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span><span class="n">actorupdate</span><span class="o">=</span><span class="n">bool_fortrain</span><span class="p">)</span>
                <span class="n">count_step_fortrain</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">bool_fortrain</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">bool_fortrain</span> <span class="c1"># Ìïú Î≤àÏùÄ criticÎßå, Ìïú Î≤àÏùÄ actor &amp; targetÍπåÏßÄ Ï†ÑÎ∂Ä ÏóÖÎç∞Ïù¥Ìä∏ÌïòÎäî Í≥ºÏ†ïÏùÑ ÍµêÎåÄÎ°ú ÏßÑÌñâ
</span>                
                
    <span class="c1">### Validation for each epoch  
</span>    <span class="k">if</span> <span class="n">epoch</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">testcase_actions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">testcase_battenergy</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">epoch_return_test</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># (undiscounted) return Ï¥àÍ∏∞Ìôî
</span>        
        <span class="n">hour</span> <span class="o">=</span> <span class="mi">24</span> <span class="c1"># ÏãúÏûëÏãúÏ†ê   
</span>        <span class="n">energy_batt</span> <span class="o">=</span> <span class="n">initialenergy_batt</span> <span class="c1"># Ï¥àÍ∏∞Ìôî
</span>        
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">load_test</span><span class="p">)</span><span class="o">-</span><span class="mi">24</span><span class="p">):</span> <span class="c1"># Îç∞Ïù¥ÌÑ∞ ÎÇ¥Ïùò ÎßàÏßÄÎßâ ÏãúÏ†êÏù¥ nextstateÏóêÎßå Ìè¨Ìï®Îê† ÎïåÍπåÏßÄ (ÎåÄÏã† termination stateÎäî Îî∞Î°ú ÏóÜÏùå)
</span>            <span class="n">energy_batt</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="nf">play_one_step</span><span class="p">(</span><span class="n">load_test</span><span class="p">,</span><span class="n">PV_prod_test</span><span class="p">,</span><span class="n">hour</span><span class="p">,</span><span class="n">energy_batt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">training</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="c1"># obsÍ∞Ä Î∞òÎ≥µ Í∞±Ïã†Îê®
</span>            <span class="n">testcase_actions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
            <span class="n">testcase_battenergy</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">energy_batt</span><span class="p">)</span>
            <span class="n">epoch_return_test</span> <span class="o">+=</span> <span class="n">reward</span> <span class="c1"># ÎàÑÏ†ÅÎ≥¥ÏÉÅ Í≥ÑÏÇ∞
</span>            <span class="n">hour</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># ÏãúÍ∞ÑÏùò ÌùêÎ¶Ñ Î∞òÏòÅ
</span>        
        <span class="n">profits_test</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">epoch_return_test</span><span class="p">)</span> <span class="c1"># Í∞Å epochÎ≥Ñ returnÏùò Î¶¨Ïä§Ìä∏ ÎßåÎì¶    
</span>        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="s">'trajectory_profit_test_td3.txt'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">profits_test</span><span class="p">:</span>
                <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="n">max_return_test</span> <span class="o">&lt;</span> <span class="n">epoch_return_test</span><span class="p">:</span> <span class="c1"># Validation setÏóêÏÑúÏùò undiscounted return ÏµúÎåÄÍ∞í Í∞±Ïã†ÏãúÎßàÎã§ Ï†ÄÏû• (ÌõàÎ†®Ïù¥ ÎßùÍ∞ÄÏßÄÎäî Í≤ΩÏö∞ Ï§ëÍ∞ÑÏóê best performanceÏòÄÎçò Î™®Îç∏ÏùÑ ÎÇ®Í∏∞Í≤åÎÅî)
</span>            <span class="n">max_return_test</span> <span class="o">=</span> <span class="n">epoch_return_test</span>
            <span class="n">actor_learning</span><span class="p">.</span><span class="nf">save_weights</span><span class="p">(</span><span class="s">'actor_trainedmodel_td3.h5'</span><span class="p">)</span>
            <span class="n">critic_one_learning</span><span class="p">.</span><span class="nf">save_weights</span><span class="p">(</span><span class="s">'critic_one_trainedmodel_td3.h5'</span><span class="p">)</span>
            <span class="n">critic_two_learning</span><span class="p">.</span><span class="nf">save_weights</span><span class="p">(</span><span class="s">'critic_two_trainedmodel_td3.h5'</span><span class="p">)</span>
                    
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="s">'trajectory_actions_test_td3.txt'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">testcase_actions</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="s">'trajectory_battenergy_test_td3.txt'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">testcase_battenergy</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                        
        <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>   
        <span class="n">elapsedtime_test</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">elapsed_time</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Validation: profit of epoch {} is {}, maximum profit is {}"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span><span class="nf">round</span><span class="p">(</span><span class="n">epoch_return_test</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="nf">round</span><span class="p">(</span><span class="n">max_return_test</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">'one epoch ÏàòÌñâÏóê {}Ï¥à Í±∏Î†∏ÏäµÎãàÎã§'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="nf">round</span><span class="p">(</span><span class="n">elapsed_time</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="s">'trajectory_time_test_td3.txt'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">elapsedtime_test</span><span class="p">:</span>
                <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>(ÏΩîÎìú ÏÑ§Î™Ö -&gt; DDPG ÎåÄÎπÑ Îã§Î•∏ Î∂ÄÎ∂ÑÎßå)</p>

<p><br /></p>
<h2 id="sac">SAC</h2>

<p>SACÏóêÏÑúÎäî `stochastic‚Äô actorÎ•º Í∞ÄÏ†ïÌïúÎã§. Ï¶â actorÎäî ÌäπÏ†ï ÌôïÎ•†Î∂ÑÌè¨Î°úÎ∂ÄÌÑ∞ actionÏùÑ ÎèÑÏ∂úÌïúÎã§. $a_{t} \sim \pi_{\phi}(a|s_{t})$ Ïù∏ Í≤ÉÏù¥Îã§. Î≥¥ÌÜµ ActorÏùò ÏßÅÏ†ëÏ†ÅÏù∏ Ï∂úÎ†•ÏùÄ Ï†ïÍ∑úÎ∂ÑÌè¨Ïùò ÌèâÍ∑†Í∞í Í∑∏Î¶¨Í≥† ÌëúÏ§ÄÌé∏Ï∞®Ïùò Î°úÍ∑∏Í∞íÏù¥Í≥†, Ïù¥Î°úÎ∂ÄÌÑ∞ Ï†ïÏùòÎêòÎäî Ï†ïÍ∑úÎ∂ÑÌè¨Î°úÎ∂ÄÌÑ∞ ÏÉòÌîåÏùÑ ÎΩëÍ±∞ÎÇò (training) ÌèâÍ∑†Í∞íÏùÑ (validation) ÎΩëÎäîÎã§. ÎßåÏïΩ bounded actionÏù∏ Í≤ΩÏö∞ tanh kernelÏùÑ Ï∂îÍ∞ÄÌï¥ÏÑú actionÏùÑ Í≤∞Ï†ïÌïúÎã§. Stochastic actorÎ•º Ïì∞Í∏∞ ÎïåÎ¨∏Ïóê, DQN/ DDPG/ TD3ÏóêÏÑú Í∑∏Îû¨Îçò Í≤ÉÏ≤òÎüº hand-crafted noiseÎ•º Îî∞Î°ú Ï∂îÍ∞ÄÌïòÏßÄ ÏïäÏïÑÎèÑ ÏûêÎèôÏúºÎ°ú ÌõàÎ†® Í≥ºÏ†ïÏóêÏÑú explorationÏù¥ ÎêúÎã§Îäî Ïû•Ï†êÏù¥ ÏûàÎã§.</p>

<p>Í∑∏Î¶¨Í≥† SACÏóêÏÑúÎäî Ïã†Í≤ΩÎßùÎì§ÏùÑ ÌõàÎ†® Ïãú `ÏµúÎåÄÌôî‚Äô ÎåÄÏÉÅ Î™©Ï†ÅÌï®ÏàòÏóê entropy term $-\alpha \text{log} \pi_{\phi}(a|s_{t}) $ Ïù¥ Ï∂îÍ∞ÄÎêúÎã§ (Î°úÍ∑∏ÌôïÎ•†Í∞íÏùÄ actorÎ•º call Ìï† Îïå Î∞õÏïÑÏò¥). Ï†ïÎ≥¥Ïù¥Î°†ÏóêÏÑú EntropyÎäî ÏùåÏùò ÌôïÎ•†Ïóê Î°úÍ∑∏ÌôïÎ•†ÏùÑ Í≥±Ìïú Í∞íÏù¥Í≥† Î™©Ï†ÅÌï®ÏàòÎäî ÌèâÍ∑†ÏùÑ ÏùòÎØ∏ÌïòÎØÄÎ°ú ÏïûÏóê ÌôïÎ•†Í∞íÏù¥ ÏÉùÎûµÎêú Í≤ÉÏúºÎ°ú Î≥¥Î©¥ ÏúÑ termÏùÄ entropyÎ•º ÏùòÎØ∏ÌïúÎã§. EntropyÍ∞Ä ÌÅ¥ÏàòÎ°ù Ìï¥Îãπ ÌôïÎ•†Î∂ÑÌè¨Í∞Ä Í∑†Îì±Î∂ÑÌè¨Ïóê Í∞ÄÍπåÏõåÏßÄÎØÄÎ°ú, Í≤∞Í≥ºÏ†ÅÏúºÎ°ú explorationÏùÑ Ïû•Î†§ÌïòÍ≤å ÎêúÎã§.</p>

<p>$\alpha$Îäî temperature parameterÎ°ú, ÌÅ¥ÏàòÎ°ù entropyÏùò ÏµúÎåÄÌôîÏóê Í∞ÄÏ§ëÏπòÎ•º ÎßéÏù¥ Ï§òÏÑú Í∑†Îì±Î∂ÑÌè¨Ïóê Îçî Í∞ÄÍπåÏõåÏßÑÎã§. SACÏóêÏÑúÎäî $\alpha$Î•º ÏÇ¨Ï†ÑÏóê Í≥†Ï†ïÎêú Í∞íÏúºÎ°ú Í≤∞Ï†ïÌïòÏßÄ ÏïäÍ≥†, $\alpha$Í∞Ä minimum expected entropy Ï°∞Í±¥ ÌïòÏùò return ÏµúÎåÄÌôî Î¨∏Ï†úÏùò dual problemÏùò Lagrangian multiplierÏûÑÏóê Ï∞©ÏïàÌï¥ Í∑∏ Í∞íÏùÑ Î≥ÄÍ≤ΩÌï¥ ÎÇòÍ∞ÑÎã§. Í∑∏Îü¨ÎØÄÎ°ú $\alpha$Ïùò Ï¥àÍ∏∞Í∞íÏùÄ ÏÇ¨Ïö©ÏûêÍ∞Ä Í≤∞Ï†ïÌïòÏßÄÎßå, Í∑∏ Í∞íÏùÄ ÌõàÎ†®ÏùÑ Í±∞ÏπòÎ©¥ÏÑú ÏßÄÏÜçÏ†ÅÏúºÎ°ú ÏàòÏ†ïÎêúÎã§. (Ïó≠Ïãú ÏÉÅÏÑ∏ ÎÇ¥Ïö©ÏùÄ ÎÖºÎ¨∏ ÏõêÎ¨∏ÏùÑ Ï∞∏Í≥†ÌïòÏûê.)</p>

<p>SAC ÌõàÎ†® ÏΩîÎìúÎäî ÏïÑÎûòÏôÄ Í∞ôÎã§ <a href="https://github.com/shakti365/soft-actor-critic">(ÏΩîÎìú ÏûëÏÑ±Ïóê Ï∞∏Í≥†Ìïú Ìè¨Ïä§ÌåÖ)</a></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># -*- coding: utf-8 -*-
</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">import</span> <span class="n">tensorflow_probability</span> <span class="k">as</span> <span class="n">tfp</span>
<span class="kn">from</span> <span class="n">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="n">keras.layers</span> <span class="kn">import</span> <span class="n">Input</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Conv1D</span><span class="p">,</span> <span class="n">concatenate</span><span class="p">,</span> <span class="n">Flatten</span>
<span class="kn">import</span> <span class="n">time</span>

<span class="c1">### hyperparameters
</span>
<span class="n">alpha_lr</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">actor_lr</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="c1"># learning rate ÎÑàÎ¨¥ ÌÅ¨Í≤å ÌïòÎ©¥ Î∞úÏÇ∞ÌïòÎäî Í≤ΩÏö∞ ÏûàÏúºÎØÄÎ°ú Ï£ºÏùò, ÌõàÎ†®Ïù¥ ÏßÄÏÜçÎê†ÏàòÎ°ù profitÏù¥ Ïò§ÌûàÎ†§ ÏùºÍ¥ÄÎêòÍ≤å Í∞êÏÜåÌïòÎ©¥ learning rateÎ•º ÎÇÆÏ∂∞Î≥¥Îäî Í≤å Ï¢ãÏùå
</span><span class="n">critic_lr</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">tau</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="c1"># target NNÎì§ ÏóÖÎç∞Ïù¥Ìä∏ Í¥ÄÎ†®
</span><span class="n">alpha_initial</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1"># temperature parameter
</span><span class="n">target_entropy</span> <span class="o">=</span> <span class="o">-</span><span class="n">tf</span><span class="p">.</span><span class="nf">constant</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span> <span class="c1"># 1ÏùÄ DoF of action
</span><span class="n">rewardscalefactor</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># SACÍ∞Ä reward scaleÏóê ÎØºÍ∞êÌïòÎØÄÎ°ú Ïûò ÏÑ†ÌÉùÌï¥Ïïº Ìï®: rewardÍ∞Ä ÎÑàÎ¨¥ ÎÇÆÏúºÎ©¥ ÎÑàÎ¨¥ explorationÎßå Ìï¥Î≤ÑÎ¶¨Í≥†, rewardÍ∞Ä ÎÑàÎ¨¥ ÎÜíÏúºÎ©¥ Ï≤òÏùåÏóî ÌïôÏäµÏù¥ Îπ®Î¶¨ ÎêòÎäî Í≤É Í∞ôÏïÑ Î≥¥Ïù¥ÏßÄÎßå poor local minimaÎ°ú ÏàòÎ†¥Ìï®
</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">20000</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">discount_factor</span> <span class="o">=</span> <span class="mf">0.98</span>
<span class="n">period_step_fortrain</span> <span class="o">=</span> <span class="mi">24</span>




<span class="c1">### microgrid system data
</span>
<span class="n">PV_prod_train</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="s">'BelgiumPV_prod_train.npy'</span><span class="p">)[:</span><span class="mi">96</span><span class="p">]</span> <span class="c1"># [0,1] Íµ¨Í∞Ñ ÎÇ¥Î°ú scaledÎêú Îç∞Ïù¥ÌÑ∞ÏûÑ, unscalingÏùÄ play_one_step Ìï®Ïàò ÎÇ¥ÏóêÏÑú Ïù¥Î£®Ïñ¥Ïßê
</span><span class="n">PV_prod_test</span>  <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="s">'BelgiumPV_prod_test.npy'</span><span class="p">)[:</span><span class="mi">96</span><span class="p">]</span>  

<span class="n">load_train</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="s">'example_nondeterminist_cons_train.npy'</span><span class="p">)[:</span><span class="mi">96</span><span class="p">]</span>  <span class="c1"># [0,1] Íµ¨Í∞Ñ ÎÇ¥Î°ú scaledÎêú Îç∞Ïù¥ÌÑ∞ÏûÑ, unscalingÏùÄ play_one_step Ìï®Ïàò ÎÇ¥ÏóêÏÑú Ïù¥Î£®Ïñ¥Ïßê
</span><span class="n">load_test</span>  <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="s">'example_nondeterminist_cons_test.npy'</span><span class="p">)[:</span><span class="mi">96</span><span class="p">]</span> 

<span class="n">prate_h2</span> <span class="o">=</span> <span class="mf">1.1</span> <span class="c1"># ÏàòÏÜåÌÉ±ÌÅ¨Í∏∞Ï§ÄÏúºÎ°ú ÏµúÎåÄ Ïú†Ï∂úÏûÖÍ∞ÄÎä•Îüâ
</span><span class="n">eff_h2</span> <span class="o">=</span> <span class="mf">0.65</span> <span class="c1"># ÏàòÏÜå-Ï†ÑÍ∏∞ Î≥ÄÌôòÌö®Ïú®
</span>
<span class="n">capa_batt</span> <span class="o">=</span> <span class="mi">15</span> <span class="c1"># Î∞∞ÌÑ∞Î¶¨ Ïö©Îüâ (Í≤âÎ≥¥Í∏∞Ïö©Îüâ ÎßêÍ≥† SOC ÏÉÅÌïòÌïú Í≥†Î†§Ìïú Ïã§Ïö©ÎüâÏù¥Îùº Í∞ÄÏ†ï)
</span><span class="n">eff_batt</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="c1"># Î∞∞ÌÑ∞Î¶¨ Ï∂©Î∞©Ï†Ñ Ìö®Ïú®
</span><span class="n">initialenergy_batt</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># epochÏùò ÏãúÏûëÏóêÏÑú Î∞∞ÌÑ∞Î¶¨ ÎÇ¥ ÏóêÎÑàÏßÄÎüâ (ÏµúÎåÄÏ†ÄÏû•Í∞ÄÎä•Îüâ ÎåÄÎπÑ ÏÉÅÎåÄÎπÑÏú®, Qval NNÏóêÎäî Ïù¥ ÏÉÅÎåÄÎπÑÏú®Ïù¥ ÏûÖÎ†•ÎêòÎ©∞, play_one_step Ìï®Ïàò ÎÇ¥ÏóêÏÑúÏùò ÏóêÎÑàÏßÄÏãúÏä§ÌÖú Î∞∏Îü∞Ïä§ ÏàòÏãùÏóêÏÑúÎäî Ïã§Ï†ú ÏóêÎÑàÏßÄÍ∞íÏúºÎ°ú Î≥ÄÌôòÎê®
</span>
<span class="n">price_h2</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">cost_loss</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">maxpower_h2</span> <span class="o">=</span> <span class="mf">1.1</span>

<span class="n">load_peak</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">pv_peak</span> <span class="o">=</span> <span class="mi">12</span>

<span class="n">inputlen_load</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">inputlen_pv</span> <span class="o">=</span> <span class="mi">24</span>



<span class="c1">### Neural net configuration
</span>
<span class="k">class</span> <span class="nc">Critic</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span> <span class="c1"># Q-valueÎ•º Ï∂îÏ†ïÌïòÎäî NN (actionÏù¥ continuous)
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">Critic</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span> <span class="c1"># tf.Keras.Model ÏÉÅÏÜçÎ∞õÎäî Ïù¥Ïú†Îäî mainÏΩîÎìúÏóêÏÑú get_weights, set_weights Îì±ÏùÑ Îß§Î≤à model Î©îÏÜåÎìúÎ•º Î∂àÎü¨Ïò§ÏßÄ ÏïäÍ≥†ÎèÑ Ìé∏ÌïòÍ≤å Ïì∞Í∏∞ ÏúÑÌï®          
</span>        <span class="n">self</span><span class="p">.</span><span class="n">input_load</span> <span class="o">=</span> <span class="nc">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">inputlen_load</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># Í≥ºÍ±∞ 12ÏãúÍ∞ÑÏùò Î∂ÄÌïò, shapeÏùò ÎëêÎ≤àÏß∏ Ïà´ÏûêÎäî Ï±ÑÎÑê Ïàò (Ïª¨Îü¨ÏÇ¨ÏßÑÏùò RGB Í∞ôÏùÄ), Ïù¥Í≤å ÏûàÏñ¥Ïïº Conv1DÍ∞Ä ÏûëÎèôÌï®
</span>        <span class="n">self</span><span class="p">.</span><span class="n">input_pv</span> <span class="o">=</span> <span class="nc">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">inputlen_pv</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># Í≥ºÍ±∞ 12ÏãúÍ∞ÑÏùò ÌÉúÏñëÍ¥ëÎ∞úÏ†ÑÎüâ
</span>        <span class="n">self</span><span class="p">.</span><span class="n">hidden_conv_load</span> <span class="o">=</span> <span class="nc">Conv1D</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">input_load</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hidden_conv_pv</span> <span class="o">=</span> <span class="nc">Conv1D</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">input_pv</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">concat_conv</span> <span class="o">=</span> <span class="nf">concatenate</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="n">hidden_conv_load</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="n">hidden_conv_pv</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hidden_conv_concat</span> <span class="o">=</span> <span class="nc">Conv1D</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">concat_conv</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">flatten_conv</span> <span class="o">=</span> <span class="nc">Flatten</span><span class="p">()(</span><span class="n">self</span><span class="p">.</span><span class="n">hidden_conv_concat</span><span class="p">)</span> <span class="c1"># DenseÏ∏µ ÏßÅÏ†ÑÏóêÎäî ConvÏ∏µÏùÑ FlattenÌïòÎäî Í≤É Î™ÖÏã¨
</span>        <span class="n">self</span><span class="p">.</span><span class="n">input_others</span> <span class="o">=</span> <span class="nc">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># ÌòÑÏû¨ Î∞∞ÌÑ∞Î¶¨ ÎÇ¥ ÏóêÎÑàÏßÄÎüâ
</span>        <span class="n">self</span><span class="p">.</span><span class="n">input_action</span> <span class="o">=</span> <span class="nc">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># action Í∞í
</span>        <span class="n">self</span><span class="p">.</span><span class="n">concat_all</span> <span class="o">=</span> <span class="nf">concatenate</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="n">flatten_conv</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="n">input_others</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="n">input_action</span><span class="p">])</span> 
        <span class="n">self</span><span class="p">.</span><span class="n">hidden_dense_1</span> <span class="o">=</span> <span class="nc">Dense</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">concat_all</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hidden_dense_2</span> <span class="o">=</span> <span class="nc">Dense</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">hidden_dense_1</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">output_qval</span> <span class="o">=</span> <span class="nc">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">hidden_dense_2</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="p">.</span><span class="nc">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">input_load</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="n">input_pv</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="n">input_others</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="n">input_action</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">output_qval</span><span class="p">])</span>     
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">input_load</span><span class="p">,</span><span class="n">input_pv</span><span class="p">,</span><span class="n">input_others</span><span class="p">,</span><span class="n">input_action</span><span class="p">):</span> <span class="c1"># state Îøê ÏïÑÎãàÎùº actionÎèÑ inputÏûÑ        
</span>        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">model</span><span class="p">((</span><span class="n">input_load</span><span class="p">,</span><span class="n">input_pv</span><span class="p">,</span><span class="n">input_others</span><span class="p">,</span><span class="n">input_action</span><span class="p">))</span> <span class="c1"># outputÏùÄ ÏûÖÎ†•Îêú state-action pairÏóê ÎåÄÌïú Q-value 'Îã®ÏùºÍ∞í'
</span>
<span class="k">class</span> <span class="nc">Actor</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span> <span class="c1"># (Continuous) ActionÏùÑ Í≤∞Ï†ïÌïòÎäî policy NN
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">Actor</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span> <span class="c1"># tf.Keras.Model ÏÉÅÏÜçÎ∞õÎäî Ïù¥Ïú†Îäî mainÏΩîÎìúÏóêÏÑú get_weights, set_weights Îì±ÏùÑ Îß§Î≤à model Î©îÏÜåÎìúÎ•º Î∂àÎü¨Ïò§ÏßÄ ÏïäÍ≥†ÎèÑ Ìé∏ÌïòÍ≤å Ïì∞Í∏∞ ÏúÑÌï®          
</span>        <span class="n">self</span><span class="p">.</span><span class="n">input_load</span> <span class="o">=</span> <span class="nc">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">inputlen_load</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># Í≥ºÍ±∞ 12ÏãúÍ∞ÑÏùò Î∂ÄÌïò, shapeÏùò ÎëêÎ≤àÏß∏ Ïà´ÏûêÎäî Ï±ÑÎÑê Ïàò (Ïª¨Îü¨ÏÇ¨ÏßÑÏùò RGB Í∞ôÏùÄ), Ïù¥Í≤å ÏûàÏñ¥Ïïº Conv1DÍ∞Ä ÏûëÎèôÌï®
</span>        <span class="n">self</span><span class="p">.</span><span class="n">input_pv</span> <span class="o">=</span> <span class="nc">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">inputlen_pv</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># Í≥ºÍ±∞ 12ÏãúÍ∞ÑÏùò ÌÉúÏñëÍ¥ëÎ∞úÏ†ÑÎüâ
</span>        <span class="n">self</span><span class="p">.</span><span class="n">hidden_conv_load</span> <span class="o">=</span> <span class="nc">Conv1D</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">input_load</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hidden_conv_pv</span> <span class="o">=</span> <span class="nc">Conv1D</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">input_pv</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">concat_conv</span> <span class="o">=</span> <span class="nf">concatenate</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="n">hidden_conv_load</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="n">hidden_conv_pv</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hidden_conv_concat</span> <span class="o">=</span> <span class="nc">Conv1D</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">concat_conv</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">flatten_conv</span> <span class="o">=</span> <span class="nc">Flatten</span><span class="p">()(</span><span class="n">self</span><span class="p">.</span><span class="n">hidden_conv_concat</span><span class="p">)</span> <span class="c1"># DenseÏ∏µ ÏßÅÏ†ÑÏóêÎäî ConvÏ∏µÏùÑ FlattenÌïòÎäî Í≤É Î™ÖÏã¨
</span>        <span class="n">self</span><span class="p">.</span><span class="n">input_others</span> <span class="o">=</span> <span class="nc">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># ÌòÑÏû¨ Î∞∞ÌÑ∞Î¶¨ ÎÇ¥ ÏóêÎÑàÏßÄÎüâ
</span>        <span class="n">self</span><span class="p">.</span><span class="n">concat_all</span> <span class="o">=</span> <span class="nf">concatenate</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="n">flatten_conv</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="n">input_others</span><span class="p">])</span> 
        <span class="n">self</span><span class="p">.</span><span class="n">hidden_dense_1</span> <span class="o">=</span> <span class="nc">Dense</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">concat_all</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hidden_dense_2</span> <span class="o">=</span> <span class="nc">Dense</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">hidden_dense_1</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">output_action_mean</span> <span class="o">=</span> <span class="nc">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">'linear'</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">hidden_dense_2</span><span class="p">)</span> <span class="c1"># Ï†ïÍ∑úÎ∂ÑÌè¨Ïùò ÌèâÍ∑†
</span>        <span class="n">self</span><span class="p">.</span><span class="n">output_action_stddev</span> <span class="o">=</span> <span class="nc">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">'linear'</span><span class="p">)(</span><span class="n">self</span><span class="p">.</span><span class="n">hidden_dense_2</span><span class="p">)</span> <span class="c1"># Ï†ïÍ∑úÎ∂ÑÌè¨Ïùò ÌëúÏ§ÄÌé∏Ï∞®
</span>        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="p">.</span><span class="nc">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">input_load</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="n">input_pv</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="n">input_others</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">output_action_mean</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="n">output_action_stddev</span><span class="p">])</span>     
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">input_load</span><span class="p">,</span><span class="n">input_pv</span><span class="p">,</span><span class="n">input_others</span><span class="p">,</span><span class="n">training</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span> <span class="c1"># stateÍ∞Ä inputÏûÑ        
</span>        <span class="n">mu</span><span class="p">,</span> <span class="n">logsigma</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">model</span><span class="p">((</span><span class="n">input_load</span><span class="p">,</span><span class="n">input_pv</span><span class="p">,</span><span class="n">input_others</span><span class="p">))</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="n">logsigma</span><span class="p">)</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">tfp</span><span class="p">.</span><span class="n">distributions</span><span class="p">.</span><span class="nc">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">training</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">action_temp</span> <span class="o">=</span> <span class="n">dist</span><span class="p">.</span><span class="nf">sample</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">action_temp</span> <span class="o">=</span> <span class="n">mu</span> <span class="c1"># test ÏãúÏóêÎäî mean actionÏúºÎ°ú (deterministic actionÏúºÎ°ú testÌïòÎØÄÎ°ú)
</span>        <span class="n">action</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="nf">tanh</span><span class="p">(</span><span class="n">action_temp</span><span class="p">)</span> <span class="c1"># bounded action Íµ¨ÌòÑ
</span>        <span class="n">logprob_temp</span> <span class="o">=</span> <span class="n">dist</span><span class="p">.</span><span class="nf">log_prob</span><span class="p">(</span><span class="n">action_temp</span><span class="p">)</span>
        <span class="n">logprob</span> <span class="o">=</span> <span class="n">logprob_temp</span> <span class="o">-</span> <span class="n">tf</span><span class="p">.</span><span class="nf">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">action</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">1e-16</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">keepdims</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1"># log-probability Î∞òÌôò
</span>        <span class="k">return</span> <span class="n">action</span><span class="p">,</span> <span class="n">logprob</span>
        

<span class="n">critic_one_learning</span> <span class="o">=</span> <span class="nc">Critic</span><span class="p">()</span>
<span class="n">critic_one_target</span> <span class="o">=</span> <span class="nc">Critic</span><span class="p">()</span>
<span class="n">critic_one_learning</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="p">.</span><span class="n">optimizers</span><span class="p">.</span><span class="nc">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">critic_lr</span><span class="p">))</span>
<span class="n">critic_one_target</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="p">.</span><span class="n">optimizers</span><span class="p">.</span><span class="nc">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">critic_lr</span><span class="p">))</span>
<span class="n">critic_one_target</span><span class="p">.</span><span class="nf">set_weights</span><span class="p">(</span><span class="n">critic_one_learning</span><span class="p">.</span><span class="nf">get_weights</span><span class="p">())</span> <span class="c1"># target netÏùò Í∞ÄÏ§ëÏπòÎ•º learning netÏùò Í∞ÄÏ§ëÏπòÏôÄ Í∞ôÍ≤å Ï¥àÍ∏∞Ìôî
</span>
<span class="n">critic_two_learning</span> <span class="o">=</span> <span class="nc">Critic</span><span class="p">()</span>
<span class="n">critic_two_target</span> <span class="o">=</span> <span class="nc">Critic</span><span class="p">()</span>
<span class="n">critic_two_learning</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="p">.</span><span class="n">optimizers</span><span class="p">.</span><span class="nc">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">critic_lr</span><span class="p">))</span>
<span class="n">critic_two_target</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="p">.</span><span class="n">optimizers</span><span class="p">.</span><span class="nc">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">critic_lr</span><span class="p">))</span>
<span class="n">critic_two_target</span><span class="p">.</span><span class="nf">set_weights</span><span class="p">(</span><span class="n">critic_two_learning</span><span class="p">.</span><span class="nf">get_weights</span><span class="p">())</span> <span class="c1"># target netÏùò Í∞ÄÏ§ëÏπòÎ•º learning netÏùò Í∞ÄÏ§ëÏπòÏôÄ Í∞ôÍ≤å Ï¥àÍ∏∞Ìôî
</span>
<span class="n">actor_learning</span> <span class="o">=</span> <span class="nc">Actor</span><span class="p">()</span>
<span class="n">actor_target</span> <span class="o">=</span> <span class="nc">Actor</span><span class="p">()</span>
<span class="n">actor_learning</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="p">.</span><span class="n">optimizers</span><span class="p">.</span><span class="nc">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">actor_lr</span><span class="p">))</span>
<span class="n">actor_target</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="p">.</span><span class="n">optimizers</span><span class="p">.</span><span class="nc">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">actor_lr</span><span class="p">))</span>
<span class="n">actor_target</span><span class="p">.</span><span class="nf">set_weights</span><span class="p">(</span><span class="n">actor_learning</span><span class="p">.</span><span class="nf">get_weights</span><span class="p">())</span> <span class="c1"># target netÏùò Í∞ÄÏ§ëÏπòÎ•º learning netÏùò Í∞ÄÏ§ëÏπòÏôÄ Í∞ôÍ≤å Ï¥àÍ∏∞Ìôî
</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="nc">Variable</span><span class="p">(</span><span class="n">alpha_initial</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">alpha_optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">optimizers</span><span class="p">.</span><span class="nc">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">alpha_lr</span><span class="p">)</span> <span class="c1"># ÎÑàÎ¨¥ ÎÜíÏúºÎ©¥ alphaÍ∞Ä Ïñ¥Îäê ÏàúÍ∞Ñ nanÍ∞Ä ÎêòÏñ¥Î≤ÑÎ¶º 
</span>
<span class="n">actor_weight_temp</span> <span class="o">=</span> <span class="n">actor_learning</span><span class="p">.</span><span class="nf">get_weights</span><span class="p">()</span>
<span class="n">critic_one_weight_temp</span> <span class="o">=</span> <span class="n">critic_one_learning</span><span class="p">.</span><span class="nf">get_weights</span><span class="p">()</span>
<span class="n">critic_two_weight_temp</span> <span class="o">=</span> <span class="n">critic_two_learning</span><span class="p">.</span><span class="nf">get_weights</span><span class="p">()</span>


<span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="n">replay_buffer</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sample_experiences</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span> <span class="c1"># batch_sizeÎßåÌÅºÏùò Í≤ΩÌóòÎì§Ïùò stateÎì§, actionÎì§, rewardÎì§, nextstateÎì§, doneÎì§Ïùò Î¶¨Ïä§Ìä∏Îì§ÏùÑ Î∞òÌôò
</span>    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">replay_buffer</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span> <span class="c1"># replay buffer ÎÇ¥ Í≤ΩÌóòÎì§ Ï§ë ÎûúÎç§ÌïòÍ≤å batch_sizeÎßåÌÅºÏùò Í≤ΩÌóòÎì§ÏùÑ ÏßÄÏ†ï (Ïù∏Îç±Ïä§ Î∂àÎü¨Ïò¥)
</span>    <span class="n">batch</span> <span class="o">=</span> <span class="p">[</span><span class="n">replay_buffer</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span> <span class="c1"># ÏúÑÏóêÏÑú Î∂àÎü¨Ïò® Ïù∏Îç±Ïä§Î•º Ïù¥Ïö©Ìï¥ batch_size ÎßåÌÅºÏùò Í≤ΩÌóòÎì§ÏùÑ batch Î¶¨Ïä§Ìä∏Ïóê Îã¥Ïùå
</span>    <span class="n">states</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">next_states</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">experience</span><span class="p">[</span><span class="n">field_index</span><span class="p">]</span> <span class="k">for</span> <span class="n">experience</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">])</span> <span class="c1"># ÌïòÎÇòÏùò array ÏïàÏóê batch ÎÇ¥ Í∞Å Í≤ΩÌóòÎ≥Ñ Í∞íÎì§Ïù¥ Îì§Ïñ¥Í∞ê 
</span>        <span class="k">for</span> <span class="n">field_index</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span> <span class="c1"># Ï¥ù 5Í∞úÏùò arrayÎ•º Î∞òÌôò, Í∞ÅÍ∞ÅÏùÄ (batch ÎÇ¥ sampleÍ≤ΩÌóòÎì§Ïùò) stateÎì§, actionÎì§, rewardÎì§, nextstateÎì§, doneÎì§Ïùò Î¶¨Ïä§Ìä∏ÏûÑ
</span>    <span class="k">return</span> <span class="n">states</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">next_states</span>





<span class="k">def</span> <span class="nf">play_one_step</span><span class="p">(</span><span class="n">profile_load</span><span class="p">,</span><span class="n">profile_pv</span><span class="p">,</span><span class="n">hour</span><span class="p">,</span><span class="n">energy_batt</span><span class="p">,</span><span class="n">training</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        
    <span class="n">state</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">profile_load</span><span class="p">[</span><span class="n">hour</span><span class="o">-</span><span class="n">inputlen_load</span><span class="p">:</span><span class="n">hour</span><span class="p">],</span> <span class="n">profile_pv</span><span class="p">[</span><span class="n">hour</span><span class="o">-</span><span class="n">inputlen_pv</span><span class="p">:</span><span class="n">hour</span><span class="p">],</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">energy_batt</span><span class="p">]))</span> <span class="p">)</span>
     
    <span class="c1"># profile_load = load_train #(ÏΩîÎìú ÏûòÎèÑÎäîÏßÄ ÌÖåÏä§Ìä∏Ïö©)
</span>    <span class="c1"># profile_pv = PV_prod_train #(ÏΩîÎìú ÏûòÎèÑÎäîÏßÄ ÌÖåÏä§Ìä∏Ïö©)
</span>    <span class="c1"># energy_batt = initialenergy_batt #(ÏΩîÎìú ÏûòÎèÑÎäîÏßÄ ÌÖåÏä§Ìä∏Ïö©)
</span>    
    <span class="n">action</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nf">actor_learning</span><span class="p">(</span><span class="n">profile_load</span><span class="p">[</span><span class="n">hour</span><span class="o">-</span><span class="n">inputlen_load</span><span class="p">:</span><span class="n">hour</span><span class="p">].</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">inputlen_load</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">profile_pv</span><span class="p">[</span><span class="n">hour</span><span class="o">-</span><span class="n">inputlen_pv</span><span class="p">:</span><span class="n">hour</span><span class="p">].</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">inputlen_pv</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">energy_batt</span><span class="p">]).</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">training</span><span class="o">=</span><span class="n">training</span><span class="p">)</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">action</span><span class="p">.</span><span class="nf">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># action netÏùò outputÏùÄ tensorÏù¥ÎØÄÎ°ú Ïù¥Î•º numpy Î≥ÄÌôò ÌõÑ [0][0] Î∂ôÏó¨ÏÑú Îã®Ïàú intÎ°ú ÎßåÎì¶
</span>
        
    <span class="c1"># Unscaling
</span>    <span class="n">p_h2_send</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">p_h2_receive</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">action</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">p_h2_receive</span> <span class="o">=</span> <span class="n">prate_h2</span><span class="o">*</span><span class="n">action</span> <span class="c1"># Ïó¨Í∏∞ÏÑúÎäî ÏàòÏÜåÎ°ú ÏÉùÏÇ∞Îêú Ï†ÑÍ∏∞Î•º 'Î∞õÏùÑ Îïå' ÏñëÏàòÎùºÍ≥† Í∞ÄÏ†ï
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="n">p_h2_send</span> <span class="o">=</span> <span class="o">-</span><span class="n">prate_h2</span><span class="o">*</span><span class="n">action</span> <span class="c1"># prate_h2Î•º Í≥±Ìï¥Ï£ºÎäî Í≤ÉÏùÄ unscalingÏúºÎ°ú Î≥º Ïàò ÏûàÏùå
</span>    <span class="n">p_load</span> <span class="o">=</span> <span class="n">profile_load</span><span class="p">[</span><span class="n">hour</span><span class="p">]</span><span class="o">*</span><span class="n">load_peak</span> <span class="c1"># ÌòÑÏû¨ ÏãúÍ∞ÑÏùò Î∂ÄÌïò (action Í≤∞Ï†ï Í∏∞Ï§ÄÏù¥ ÏïÑÎãò!), ÏûÖÎ†•ÏûêÎ£åÍ∞Ä [0,1]Î°ú scaledÎêú Í±∏ unscalingÌï®
</span>    <span class="n">p_pv</span> <span class="o">=</span> <span class="n">profile_pv</span><span class="p">[</span><span class="n">hour</span><span class="p">]</span><span class="o">*</span><span class="n">pv_peak</span> <span class="c1"># ÌòÑÏû¨ ÏãúÍ∞ÑÏùò Î∞úÏ†ÑÎüâ (action Í≤∞Ï†ï Í∏∞Ï§ÄÏù¥ ÏïÑÎãò!), ÏûÖÎ†•ÏûêÎ£åÍ∞Ä [0,1]Î°ú scaledÎêú Í±∏ unscalingÌï®  
</span>    <span class="n">energy_batt</span> <span class="o">=</span> <span class="n">energy_batt</span><span class="o">*</span><span class="n">capa_batt</span> <span class="c1"># unscaling
</span>    
    
    <span class="c1"># p_curtail = 0
</span>    <span class="n">p_loss</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="n">p_net_beforebatt</span> <span class="o">=</span> <span class="n">p_pv</span> <span class="o">-</span> <span class="n">p_load</span> <span class="o">+</span> <span class="n">p_h2_receive</span> <span class="o">-</span> <span class="n">p_h2_send</span> <span class="c1"># ÌÉúÏñëÍ¥ë ÏÉùÏÇ∞, Î∂ÄÌïò Ï∂©Ï°±, H2 Î≥¥ÎÇ¥Í±∞ÎÇò Î∞õÏùÄ ÌõÑ ÏàòÏö©Í∞Ä ÏûÖÏû•ÏóêÏÑú Ï†ÑÍ∏∞ÏóêÎÑàÏßÄÍ∞Ä ÎÇ®ÏúºÎ©¥ ÏñëÏàò, Î∂ÄÏ°±ÌïòÎ©¥ ÏùåÏàò
</span>    
    <span class="k">if</span> <span class="n">p_net_beforebatt</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Ï†ÑÍ∏∞ÏóêÎÑàÏßÄÍ∞Ä ÎÇ®ÏúºÎØÄÎ°ú Î∞∞ÌÑ∞Î¶¨Ïóê Ï†ÄÏû•ÌïòÍ≥†, ÎßåÏïΩ Î∞∞ÌÑ∞Î¶¨ÎèÑ ÍΩâ Ï∞¨Îã§Î©¥ curtailÌï®
</span>        <span class="k">if</span> <span class="n">capa_batt</span> <span class="o">&gt;=</span> <span class="n">energy_batt</span> <span class="o">+</span> <span class="n">p_net_beforebatt</span><span class="o">*</span><span class="n">eff_batt</span><span class="p">:</span> <span class="c1"># Î∞∞ÌÑ∞Î¶¨Ïóê ÏûîÏó¨ Ï∂©Ï†Ñ Í∞ÄÎä•Ìïú ÏóêÎÑàÏßÄÍ∞Ä ÏúÑÏóêÏÑú ÎÇ®ÏùÄ ÏóêÎÑàÏßÄ(ÏóêÏÑú Î≥ÄÌôòÏÜêÏã§ Ï†úÌïú ÏóêÎÑàÏßÄ) Ïù¥ÏÉÅÏùº Í≤ΩÏö∞
</span>            <span class="n">energy_batt_after</span> <span class="o">=</span> <span class="n">energy_batt</span> <span class="o">+</span> <span class="n">p_net_beforebatt</span><span class="o">*</span><span class="n">eff_batt</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># ÎÇ®ÏùÄ ÏóêÎÑàÏßÄÎ•º Î∞∞ÌÑ∞Î¶¨Ïóê Îã§ Ï∂©Ï†ÑÌïòÎ©¥ ÍΩâ Ï∞®Í≥†ÎèÑ ÎÇ®ÏïÑÏÑú, curtailÌï¥Ïïº Ìï®
</span>            <span class="n">energy_batt_after</span> <span class="o">=</span> <span class="n">capa_batt</span>
            <span class="c1"># p_curtail = (energy_batt + p_net_beforebatt*eff_batt - capa_batt)/eff_batt # Í¥ÑÌò∏ ÏïàÏùÄ Î∞∞ÌÑ∞Î¶¨ ÎÇ¥Î∂Ä Í∏∞Ï§ÄÏù¥Î©∞, ÏàòÏö©Í∞Ä Î™®ÏÑ† Í∏∞Ï§Ä ÏñëÏùÑ Íµ¨ÌïòÎ†§Î©¥ eff_battÎ°ú ÎÇòÎà†Ï§òÏïº Ìï®
</span>    <span class="k">else</span><span class="p">:</span> <span class="c1"># Ï†ÑÍ∏∞ÏóêÎÑàÏßÄÍ∞Ä Î∂ÄÏ°±ÌïòÎØÄÎ°ú Î∞∞ÌÑ∞Î¶¨ ÏóêÎÑàÏßÄÎ•º Ïç®Ïïº Ìï®, Î∞∞ÌÑ∞Î¶¨ ÏóêÎÑàÏßÄÎ°úÎèÑ Î∂ÄÏ°±ÌïòÎ©¥ lossÏûÑ
</span>        <span class="k">if</span> <span class="n">energy_batt</span><span class="o">*</span><span class="n">eff_batt</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">p_net_beforebatt</span><span class="p">:</span> <span class="c1"># Î∞∞ÌÑ∞Î¶¨ ÏóêÎÑàÏßÄÎ°ú Ï∂©Îãπ Í∞ÄÎä•Ìïú Í≤ΩÏö∞
</span>            <span class="n">energy_batt_after</span> <span class="o">=</span> <span class="n">energy_batt</span> <span class="o">+</span> <span class="n">p_net_beforebatt</span><span class="o">/</span><span class="n">eff_batt</span> <span class="c1"># p_net_beforebattÍ∞Ä ÏùåÏàòÏù¥ÎØÄÎ°ú ÎßàÏù¥ÎÑàÏä§Í∞íÏù¥ Î∂ÄÏ°±Ìïú ÏóêÎÑàÏßÄ'Îüâ'Ïù¥Í≥† Í∑∏Í±∏ 'Îπº'ÎØÄÎ°ú Í≤∞Í≥ºÏ†ÅÏúºÎ°ú ÌîåÎü¨Ïä§
</span>        <span class="k">else</span><span class="p">:</span> <span class="c1"># Î∂ÄÏ°±Ìï¥ loss Î∞úÏÉù
</span>            <span class="n">energy_batt_after</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">p_loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">p_net_beforebatt</span> <span class="o">-</span> <span class="n">energy_batt</span><span class="o">*</span><span class="n">eff_batt</span>           
    
    <span class="n">reward</span> <span class="o">=</span> <span class="n">price_h2</span><span class="o">*</span><span class="n">p_h2_send</span><span class="o">*</span><span class="n">eff_h2</span> <span class="o">-</span> <span class="n">price_h2</span><span class="o">*</span><span class="n">p_h2_receive</span><span class="o">/</span><span class="n">eff_h2</span> <span class="o">-</span> <span class="n">cost_loss</span><span class="o">*</span><span class="n">p_loss</span> <span class="c1"># rewardÎèÑ scalingÌï®
</span>    <span class="n">energy_batt_after</span> <span class="o">=</span> <span class="n">energy_batt_after</span><span class="o">/</span><span class="n">capa_batt</span> <span class="c1"># Î∞∞ÌÑ∞Î¶¨ ÎÇ¥ Ï†ÄÏû•ÎüâÏùÑ [0,1] Î≤îÏúÑÎ°ú scalingÌï®
</span>    
    <span class="k">if</span> <span class="n">training</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">next_state</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">profile_load</span><span class="p">[</span><span class="n">hour</span><span class="o">-</span><span class="p">(</span><span class="n">inputlen_load</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span><span class="n">hour</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">profile_pv</span><span class="p">[</span><span class="n">hour</span><span class="o">-</span><span class="p">(</span><span class="n">inputlen_pv</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span><span class="n">hour</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">energy_batt_after</span><span class="p">]))</span> <span class="p">)</span>         
        <span class="n">replay_buffer</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reward</span><span class="o">*</span><span class="n">rewardscalefactor</span><span class="p">,</span> <span class="n">next_state</span><span class="p">))</span> <span class="c1"># tupleÏùÑ appendÌï®Ïóê Ï£ºÏùò
</span>    <span class="k">return</span> <span class="n">energy_batt_after</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">action</span>



<span class="k">def</span> <span class="nf">training_step</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span><span class="n">actorupdate</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    
    <span class="n">states</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">next_states</span> <span class="o">=</span> <span class="nf">sample_experiences</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
        
    <span class="n">input_load</span> <span class="o">=</span> <span class="n">states</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">inputlen_load</span><span class="p">].</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">inputlen_load</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> 
    <span class="n">input_pv</span> <span class="o">=</span> <span class="n">states</span><span class="p">[:,</span><span class="n">inputlen_load</span><span class="p">:(</span><span class="n">inputlen_load</span><span class="o">+</span><span class="n">inputlen_pv</span><span class="p">)].</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">inputlen_pv</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">input_others</span> <span class="o">=</span> <span class="n">states</span><span class="p">[:,(</span><span class="n">inputlen_load</span><span class="o">+</span><span class="n">inputlen_pv</span><span class="p">)].</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">input_load_next</span> <span class="o">=</span> <span class="n">next_states</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">inputlen_load</span><span class="p">].</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">inputlen_load</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">input_pv_next</span> <span class="o">=</span> <span class="n">next_states</span><span class="p">[:,</span><span class="n">inputlen_load</span><span class="p">:(</span><span class="n">inputlen_load</span><span class="o">+</span><span class="n">inputlen_pv</span><span class="p">)].</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">inputlen_pv</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">input_others_next</span> <span class="o">=</span> <span class="n">next_states</span><span class="p">[:,(</span><span class="n">inputlen_load</span><span class="o">+</span><span class="n">inputlen_pv</span><span class="p">)].</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="n">actions_by_target</span><span class="p">,</span> <span class="n">logprobs_actions_target</span> <span class="o">=</span> <span class="nf">actor_target</span><span class="p">(</span><span class="n">input_load_next</span><span class="p">,</span><span class="n">input_pv_next</span><span class="p">,</span><span class="n">input_others_next</span><span class="p">)</span><span class="c1"># gradsÍ∞Ä ÏÉùÍ∏∞ÎèÑÎ°ù GradientTape Íµ¨Î¨∏ ÎÇ¥ÏóêÏÑú model ouput TensorÎ•º Îã§Ïãú Î∂àÎü¨Ïò¥
</span>    
    <span class="n">Q_values_one_by_target</span> <span class="o">=</span> <span class="nf">critic_one_target</span><span class="p">(</span><span class="n">input_load_next</span><span class="p">,</span><span class="n">input_pv_next</span><span class="p">,</span><span class="n">input_others_next</span><span class="p">,</span><span class="n">actions_by_target</span><span class="p">)</span>
    <span class="n">Q_values_two_by_target</span> <span class="o">=</span> <span class="nf">critic_two_target</span><span class="p">(</span><span class="n">input_load_next</span><span class="p">,</span><span class="n">input_pv_next</span><span class="p">,</span><span class="n">input_others_next</span><span class="p">,</span><span class="n">actions_by_target</span><span class="p">)</span>
    <span class="n">Q_values_min_by_target</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="nf">minimum</span><span class="p">(</span><span class="n">Q_values_one_by_target</span><span class="p">,</span> <span class="n">Q_values_two_by_target</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="nf">stop_gradient</span><span class="p">(</span><span class="n">rewards</span> <span class="o">+</span> <span class="n">discount_factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">Q_values_min_by_target</span> <span class="o">-</span> <span class="n">alpha</span><span class="o">*</span><span class="n">logprobs_actions_target</span><span class="p">))</span>
    
    <span class="k">with</span> <span class="n">tf</span><span class="p">.</span><span class="nc">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span> <span class="c1"># critic net ÏóÖÎç∞Ïù¥Ìä∏Î•º ÏúÑÌïú ÏûêÎèôÎØ∏Î∂Ñ (actor net ÏóÖÎç∞Ïù¥Ìä∏ÏôÄ Î≥ÑÍ∞úÎ°ú Îë†)        
</span>        <span class="n">Q_values_one</span> <span class="o">=</span> <span class="nf">critic_one_learning</span><span class="p">(</span><span class="n">input_load</span><span class="p">,</span><span class="n">input_pv</span><span class="p">,</span><span class="n">input_others</span><span class="p">,</span><span class="n">actions</span><span class="p">.</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># ÏõêÎûò critic Ïã†Í≤ΩÎßù Ìï≠ÏóêÎäî Ïã§Ï†úÎ°ú ÌñâÌñàÎçò actionsÎ•º ÎÑ£Ïñ¥Ïïº Ìï® (noise Ìè¨Ìï®ÌïòÎäî) 
</span>        <span class="n">loss_critic_one</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="nf">reduce_mean</span><span class="p">(</span><span class="n">keras</span><span class="p">.</span><span class="n">losses</span><span class="p">.</span><span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">Q_values_one</span><span class="p">))</span> <span class="c1"># ÌèâÍ∑†Ï†úÍ≥±Ïò§Ï∞® Í≥ÑÏÇ∞
</span>    <span class="n">grads</span> <span class="o">=</span> <span class="n">tape</span><span class="p">.</span><span class="nf">gradient</span><span class="p">(</span><span class="n">loss_critic_one</span><span class="p">,</span> <span class="n">critic_one_learning</span><span class="p">.</span><span class="n">trainable_variables</span><span class="p">)</span> <span class="c1"># loss Ìï®ÏàòÎ•º modelÏùò trainable variabbles Ï†ÑÏ≤¥Ïóê ÎåÄÌï¥ ÎØ∏Î∂Ñ
</span>    <span class="n">critic_one_learning</span><span class="p">.</span><span class="n">optimizer</span><span class="p">.</span><span class="nf">apply_gradients</span><span class="p">(</span><span class="nf">zip</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="n">critic_one_learning</span><span class="p">.</span><span class="n">trainable_variables</span><span class="p">))</span> <span class="c1"># Adam optimizerÎ°ú parameter update ÏàòÌñâ, zipÏúºÎ°ú gradientÏôÄ parameter pairÎ•º ÎßûÏ∂∞Ï§å    
</span>    
    <span class="k">with</span> <span class="n">tf</span><span class="p">.</span><span class="nc">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span> <span class="c1"># critic net ÏóÖÎç∞Ïù¥Ìä∏Î•º ÏúÑÌïú ÏûêÎèôÎØ∏Î∂Ñ (actor net ÏóÖÎç∞Ïù¥Ìä∏ÏôÄ Î≥ÑÍ∞úÎ°ú Îë†)        
</span>        <span class="n">Q_values_two</span> <span class="o">=</span> <span class="nf">critic_two_learning</span><span class="p">(</span><span class="n">input_load</span><span class="p">,</span><span class="n">input_pv</span><span class="p">,</span><span class="n">input_others</span><span class="p">,</span><span class="n">actions</span><span class="p">.</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># ÏõêÎûò critic Ïã†Í≤ΩÎßù Ìï≠ÏóêÎäî Ïã§Ï†úÎ°ú ÌñâÌñàÎçò actionsÎ•º ÎÑ£Ïñ¥Ïïº Ìï® (noise Ìè¨Ìï®ÌïòÎäî) 
</span>        <span class="n">loss_critic_two</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="nf">reduce_mean</span><span class="p">(</span><span class="n">keras</span><span class="p">.</span><span class="n">losses</span><span class="p">.</span><span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">Q_values_two</span><span class="p">))</span> <span class="c1"># ÌèâÍ∑†Ï†úÍ≥±Ïò§Ï∞® Í≥ÑÏÇ∞
</span>    <span class="n">grads</span> <span class="o">=</span> <span class="n">tape</span><span class="p">.</span><span class="nf">gradient</span><span class="p">(</span><span class="n">loss_critic_two</span><span class="p">,</span> <span class="n">critic_two_learning</span><span class="p">.</span><span class="n">trainable_variables</span><span class="p">)</span> <span class="c1"># loss Ìï®ÏàòÎ•º modelÏùò trainable variabbles Ï†ÑÏ≤¥Ïóê ÎåÄÌï¥ ÎØ∏Î∂Ñ
</span>    <span class="n">critic_two_learning</span><span class="p">.</span><span class="n">optimizer</span><span class="p">.</span><span class="nf">apply_gradients</span><span class="p">(</span><span class="nf">zip</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="n">critic_two_learning</span><span class="p">.</span><span class="n">trainable_variables</span><span class="p">))</span> <span class="c1"># Adam optimizerÎ°ú parameter update ÏàòÌñâ, zipÏúºÎ°ú gradientÏôÄ parameter pairÎ•º ÎßûÏ∂∞Ï§å    
</span>    
    <span class="k">if</span> <span class="n">actorupdate</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>    
        <span class="k">with</span> <span class="n">tf</span><span class="p">.</span><span class="nc">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span> <span class="c1"># actor net ÏóÖÎç∞Ïù¥Ìä∏Î•º ÏúÑÌïú ÏûêÎèôÎØ∏Î∂Ñ (critic net ÏóÖÎç∞Ïù¥Ìä∏ÏôÄ Î≥ÑÍ∞úÎ°ú Îë†)  
</span>            <span class="n">actions_by_learner</span><span class="p">,</span> <span class="n">logprobs_actions</span> <span class="o">=</span> <span class="nf">actor_learning</span><span class="p">(</span><span class="n">input_load</span><span class="p">,</span><span class="n">input_pv</span><span class="p">,</span><span class="n">input_others</span><span class="p">)</span> <span class="c1"># gradsÍ∞Ä ÏÉùÍ∏∞ÎèÑÎ°ù GradientTape Íµ¨Î¨∏ ÎÇ¥ÏóêÏÑú model ouput TensorÎ•º Îã§Ïãú Î∂àÎü¨Ïò¥
</span>            <span class="n">Q_values_one</span> <span class="o">=</span> <span class="nf">critic_one_learning</span><span class="p">(</span><span class="n">input_load</span><span class="p">,</span><span class="n">input_pv</span><span class="p">,</span><span class="n">input_others</span><span class="p">,</span><span class="n">actions_by_learner</span><span class="p">)</span> <span class="c1"># actorÏóê ÎåÄÌïú ÎØ∏Î∂ÑÏù¥ÎØÄÎ°ú actions_by_learnerÎ•º numpyÎ°ú Î∞îÍæ∏ÏßÄ ÏïäÍ≥† TensorÎ°ú Í∑∏ÎåÄÎ°ú ÎëêÏñ¥Ïïº Ìï®
</span>            <span class="n">Q_values_two</span> <span class="o">=</span> <span class="nf">critic_two_learning</span><span class="p">(</span><span class="n">input_load</span><span class="p">,</span><span class="n">input_pv</span><span class="p">,</span><span class="n">input_others</span><span class="p">,</span><span class="n">actions_by_learner</span><span class="p">)</span> <span class="c1"># actorÏóê ÎåÄÌïú ÎØ∏Î∂ÑÏù¥ÎØÄÎ°ú actions_by_learnerÎ•º numpyÎ°ú Î∞îÍæ∏ÏßÄ ÏïäÍ≥† TensorÎ°ú Í∑∏ÎåÄÎ°ú ÎëêÏñ¥Ïïº Ìï®
</span>            <span class="n">Q_values_min</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="nf">minimum</span><span class="p">(</span><span class="n">Q_values_one</span><span class="p">,</span> <span class="n">Q_values_two</span><span class="p">)</span> <span class="c1"># GradientÍ∞Ä Î∂ôÏñ¥Ïïº ÌïòÎØÄÎ°ú np.minimumÏù¥ ÏïÑÎãàÎùº tf.math.minimumÏûÑÏóê Ï£ºÏùò
</span>            <span class="n">loss_actor</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="nf">reduce_mean</span><span class="p">(</span><span class="n">alpha</span><span class="o">*</span><span class="n">logprobs_actions</span> <span class="o">-</span> <span class="n">Q_values_min</span><span class="p">)</span> <span class="c1"># ÏùåÏùò Q-value ÏµúÏÜåÌôî, Ï¶â Q-valueÎ•º ÏµúÎåÄÌôîÌïòÎèÑÎ°ù actorÎ•º ÏóÖÎç∞Ïù¥Ìä∏Ìï®
</span>        <span class="n">grads</span> <span class="o">=</span> <span class="n">tape</span><span class="p">.</span><span class="nf">gradient</span><span class="p">(</span><span class="n">loss_actor</span><span class="p">,</span> <span class="n">actor_learning</span><span class="p">.</span><span class="n">trainable_variables</span><span class="p">)</span> <span class="c1"># loss Ìï®ÏàòÎ•º modelÏùò trainable variabbles Ï†ÑÏ≤¥Ïóê ÎåÄÌï¥ ÎØ∏Î∂Ñ
</span>        <span class="n">actor_learning</span><span class="p">.</span><span class="n">optimizer</span><span class="p">.</span><span class="nf">apply_gradients</span><span class="p">(</span><span class="nf">zip</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="n">actor_learning</span><span class="p">.</span><span class="n">trainable_variables</span><span class="p">))</span> <span class="c1"># Adam optimizerÎ°ú parameter update ÏàòÌñâ, zipÏúºÎ°ú gradientÏôÄ parameter pairÎ•º ÎßûÏ∂∞Ï§å
</span>        
        <span class="k">with</span> <span class="n">tf</span><span class="p">.</span><span class="nc">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span> <span class="c1"># alphaÏùò ÏóÖÎç∞Ïù¥Ìä∏
</span>            <span class="n">actions_by_learner</span><span class="p">,</span> <span class="n">logprobs_actions</span> <span class="o">=</span> <span class="nf">actor_learning</span><span class="p">(</span><span class="n">input_load</span><span class="p">,</span><span class="n">input_pv</span><span class="p">,</span><span class="n">input_others</span><span class="p">)</span>
            <span class="n">loss_alpha</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="nf">reduce_mean</span><span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="n">logprobs_actions</span><span class="o">+</span><span class="n">target_entropy</span><span class="p">))</span>
        <span class="n">grads</span> <span class="o">=</span> <span class="n">tape</span><span class="p">.</span><span class="nf">gradient</span><span class="p">(</span><span class="n">loss_alpha</span><span class="p">,</span> <span class="p">[</span><span class="n">alpha</span><span class="p">])</span>
        <span class="n">alpha_optimizer</span><span class="p">.</span><span class="nf">apply_gradients</span><span class="p">(</span><span class="nf">zip</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="p">[</span><span class="n">alpha</span><span class="p">]))</span>
        
        <span class="n">actor_weights</span> <span class="o">=</span> <span class="n">actor_learning</span><span class="p">.</span><span class="n">weights</span> <span class="c1"># ÏõêÎûò netÏùò weight Î∂àÎü¨Ïò¥ (Ïó∞ÏÇ∞ÏùÑ ÏúÑÌï¥)
</span>        <span class="n">target_actor_weights</span> <span class="o">=</span> <span class="n">actor_target</span><span class="p">.</span><span class="n">weights</span> <span class="c1"># target netÏùò weight Î∂àÎü¨Ïò¥
</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">actor_weights</span><span class="p">)):</span> <span class="c1"># Ïù¥Î†áÍ≤å ÌïòÎÇòÌïòÎÇò Ìï¥Ïïº ÎêòÎÇò?
</span>            <span class="n">target_actor_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">*</span> <span class="n">actor_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">tau</span><span class="p">)</span> <span class="o">*</span> <span class="n">target_actor_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">actor_target</span><span class="p">.</span><span class="nf">set_weights</span><span class="p">(</span><span class="n">target_actor_weights</span><span class="p">)</span> <span class="c1"># Ïù¥Í±∞ ÍπåÎ®πÏßÄ Îßê Í≤É!
</span>        
        <span class="n">critic_one_weights</span> <span class="o">=</span> <span class="n">critic_one_learning</span><span class="p">.</span><span class="n">weights</span> <span class="c1"># ÏõêÎûò netÏùò weight Î∂àÎü¨Ïò¥ (Ïó∞ÏÇ∞ÏùÑ ÏúÑÌï¥)
</span>        <span class="n">critic_two_weights</span> <span class="o">=</span> <span class="n">critic_two_learning</span><span class="p">.</span><span class="n">weights</span> <span class="c1"># ÏõêÎûò netÏùò weight Î∂àÎü¨Ïò¥ (Ïó∞ÏÇ∞ÏùÑ ÏúÑÌï¥)
</span>        <span class="n">target_critic_one_weights</span> <span class="o">=</span> <span class="n">critic_one_target</span><span class="p">.</span><span class="n">weights</span> <span class="c1"># target netÏùò weight Î∂àÎü¨Ïò¥
</span>        <span class="n">target_critic_two_weights</span> <span class="o">=</span> <span class="n">critic_two_target</span><span class="p">.</span><span class="n">weights</span> <span class="c1"># target netÏùò weight Î∂àÎü¨Ïò¥
</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">critic_one_weights</span><span class="p">)):</span> <span class="c1"># Ïù¥Î†áÍ≤å ÌïòÎÇòÌïòÎÇò Ìï¥Ïïº ÎêòÎÇò?
</span>            <span class="n">target_critic_one_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">*</span> <span class="n">critic_one_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">tau</span><span class="p">)</span> <span class="o">*</span> <span class="n">target_critic_one_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">target_critic_two_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">*</span> <span class="n">critic_two_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">tau</span><span class="p">)</span> <span class="o">*</span> <span class="n">target_critic_two_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">critic_one_target</span><span class="p">.</span><span class="nf">set_weights</span><span class="p">(</span><span class="n">target_critic_one_weights</span><span class="p">)</span> <span class="c1"># Ïù¥Í±∞ ÍπåÎ®πÏßÄ Îßê Í≤É!    
</span>        <span class="n">critic_two_target</span><span class="p">.</span><span class="nf">set_weights</span><span class="p">(</span><span class="n">target_critic_two_weights</span><span class="p">)</span> <span class="c1"># Ïù¥Í±∞ ÍπåÎ®πÏßÄ Îßê Í≤É!    
</span>


<span class="n">profits_test</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">elapsedtime_test</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">max_return_test</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">inf</span>
<span class="n">count_step_fortrain</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">bool_fortrain</span> <span class="o">=</span> <span class="bp">False</span>


<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span> <span class="c1"># Ïã§Ï†úÎ°úÎäî termination stateÍ∞Ä ÏóÜÎäî taskÏù∏Îç∞... epochÎ≥¥Îã® epochÍ∞Ä Îçî ÏûêÏó∞Ïä§Îü¨Ïö¥ ÌëúÌòÑÏùº ÎìØ?
</span>    <span class="k">if</span> <span class="n">epoch</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Îß® Ï≤´ Î≤àÏß∏ epochÏóêÏÑúÎäî ÌõàÎ†®ÏùÑ ÏãúÏûëÌïòÏßÄ ÏïäÍ≥† bufferÎ•º Ï±ÑÏõÄ, Îëê Î≤àÏß∏ epochÎ∂ÄÌÑ∞Îäî bufferÏóê sampleÎì§Ïù¥ Ï±ÑÏõåÏ°åÏúºÎØÄÎ°ú ÌõàÎ†®Ìï®
</span>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    
    <span class="c1">### Train for each epoch
</span>    
    <span class="n">hour</span> <span class="o">=</span> <span class="mi">24</span> <span class="c1"># ÏãúÏûëÏãúÏ†ê
</span>    <span class="n">energy_batt</span> <span class="o">=</span> <span class="n">initialenergy_batt</span>  
    
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">load_train</span><span class="p">)</span><span class="o">-</span><span class="mi">25</span><span class="p">):</span> <span class="c1"># Îç∞Ïù¥ÌÑ∞ ÎÇ¥Ïùò ÎßàÏßÄÎßâ ÏãúÏ†êÏù¥ nextstateÏóêÎßå Ìè¨Ìï®Îê† ÎïåÍπåÏßÄ (ÎåÄÏã† termination stateÎäî Îî∞Î°ú ÏóÜÏùå)
</span>        <span class="n">count_step_fortrain</span> <span class="o">+=</span> <span class="mi">1</span>      
        <span class="n">energy_batt</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="nf">play_one_step</span><span class="p">(</span><span class="n">load_train</span><span class="p">,</span><span class="n">PV_prod_train</span><span class="p">,</span><span class="n">hour</span><span class="p">,</span><span class="n">energy_batt</span><span class="p">,</span><span class="n">training</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1"># obsÍ∞Ä Î∞òÎ≥µ Í∞±Ïã†Îê®
</span>        <span class="n">hour</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># ÏãúÍ∞ÑÏùò ÌùêÎ¶Ñ Î∞òÏòÅ      
</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">count_step_fortrain</span> <span class="o">&gt;</span> <span class="n">period_step_fortrain</span><span class="p">:</span> 
                <span class="nf">training_step</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span><span class="n">actorupdate</span><span class="o">=</span><span class="n">bool_fortrain</span><span class="p">)</span>
                <span class="n">count_step_fortrain</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">bool_fortrain</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">bool_fortrain</span> <span class="c1"># Ìïú Î≤àÏùÄ criticÎßå, Ìïú Î≤àÏùÄ actor &amp; targetÍπåÏßÄ Ï†ÑÎ∂Ä ÏóÖÎç∞Ïù¥Ìä∏ÌïòÎäî Í≥ºÏ†ïÏùÑ ÍµêÎåÄÎ°ú ÏßÑÌñâ
</span>                

                <span class="k">if</span> <span class="n">np</span><span class="p">.</span><span class="nf">isnan</span><span class="p">(</span><span class="n">alpha</span><span class="p">.</span><span class="nf">numpy</span><span class="p">()):</span>
                    <span class="n">alpha</span><span class="p">.</span><span class="nf">assign</span><span class="p">(</span><span class="n">alpha_initial</span><span class="p">)</span> <span class="c1"># alphaÍ∞Ä nanÏù¥ ÎêòÎäî Î¨∏Ï†ú Î∞úÏÉù Ïãú Ï¥àÍ∏∞Í∞íÏúºÎ°ú ÎêòÎèåÎ¶º
</span>                    <span class="n">actor_learning</span><span class="p">.</span><span class="nf">set_weights</span><span class="p">(</span><span class="n">actor_weight_temp</span><span class="p">)</span>
                    <span class="n">actor_target</span><span class="p">.</span><span class="nf">set_weights</span><span class="p">(</span><span class="n">actor_weight_temp</span><span class="p">)</span>
                    <span class="n">critic_one_learning</span><span class="p">.</span><span class="nf">set_weights</span><span class="p">(</span><span class="n">critic_one_weight_temp</span><span class="p">)</span>
                    <span class="n">critic_one_target</span><span class="p">.</span><span class="nf">set_weights</span><span class="p">(</span><span class="n">critic_one_weight_temp</span><span class="p">)</span>
                    <span class="n">critic_two_learning</span><span class="p">.</span><span class="nf">set_weights</span><span class="p">(</span><span class="n">critic_two_weight_temp</span><span class="p">)</span>
                    <span class="n">critic_two_target</span><span class="p">.</span><span class="nf">set_weights</span><span class="p">(</span><span class="n">critic_two_weight_temp</span><span class="p">)</span>
                    
                <span class="n">actor_weight_temp</span> <span class="o">=</span> <span class="n">actor_learning</span><span class="p">.</span><span class="nf">get_weights</span><span class="p">()</span>
                <span class="n">critic_one_weight_temp</span> <span class="o">=</span> <span class="n">critic_one_learning</span><span class="p">.</span><span class="nf">get_weights</span><span class="p">()</span>
                <span class="n">critic_two_temp</span> <span class="o">=</span> <span class="n">critic_two_learning</span><span class="p">.</span><span class="nf">get_weights</span><span class="p">()</span>
                    
    <span class="c1">### Validation for each epoch  
</span>    <span class="k">if</span> <span class="n">epoch</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">testcase_actions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">testcase_battenergy</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">epoch_return_test</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># (undiscounted) return Ï¥àÍ∏∞Ìôî
</span>        
        <span class="n">hour</span> <span class="o">=</span> <span class="mi">24</span> <span class="c1"># ÏãúÏûëÏãúÏ†ê   
</span>        <span class="n">energy_batt</span> <span class="o">=</span> <span class="n">initialenergy_batt</span> <span class="c1"># Ï¥àÍ∏∞Ìôî
</span>        
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">load_test</span><span class="p">)</span><span class="o">-</span><span class="mi">24</span><span class="p">):</span> <span class="c1"># Îç∞Ïù¥ÌÑ∞ ÎÇ¥Ïùò ÎßàÏßÄÎßâ ÏãúÏ†êÏù¥ nextstateÏóêÎßå Ìè¨Ìï®Îê† ÎïåÍπåÏßÄ (ÎåÄÏã† termination stateÎäî Îî∞Î°ú ÏóÜÏùå)
</span>            <span class="n">energy_batt</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="nf">play_one_step</span><span class="p">(</span><span class="n">load_test</span><span class="p">,</span><span class="n">PV_prod_test</span><span class="p">,</span><span class="n">hour</span><span class="p">,</span><span class="n">energy_batt</span><span class="p">,</span><span class="n">training</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="c1"># obsÍ∞Ä Î∞òÎ≥µ Í∞±Ïã†Îê®
</span>            <span class="n">testcase_actions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
            <span class="n">testcase_battenergy</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">energy_batt</span><span class="p">)</span>
            <span class="n">epoch_return_test</span> <span class="o">+=</span> <span class="n">reward</span> <span class="c1"># ÎàÑÏ†ÅÎ≥¥ÏÉÅ Í≥ÑÏÇ∞
</span>            <span class="n">hour</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># ÏãúÍ∞ÑÏùò ÌùêÎ¶Ñ Î∞òÏòÅ
</span>        
        <span class="n">profits_test</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">epoch_return_test</span><span class="p">)</span> <span class="c1"># Í∞Å epochÎ≥Ñ returnÏùò Î¶¨Ïä§Ìä∏ ÎßåÎì¶    
</span>        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="s">'trajectory_profit_test_sac.txt'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">profits_test</span><span class="p">:</span>
                <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="n">max_return_test</span> <span class="o">&lt;</span> <span class="n">epoch_return_test</span><span class="p">:</span> <span class="c1"># Validation setÏóêÏÑúÏùò undiscounted return ÏµúÎåÄÍ∞í Í∞±Ïã†ÏãúÎßàÎã§ Ï†ÄÏû• (ÌõàÎ†®Ïù¥ ÎßùÍ∞ÄÏßÄÎäî Í≤ΩÏö∞ Ï§ëÍ∞ÑÏóê best performanceÏòÄÎçò Î™®Îç∏ÏùÑ ÎÇ®Í∏∞Í≤åÎÅî)
</span>            <span class="n">max_return_test</span> <span class="o">=</span> <span class="n">epoch_return_test</span>
            <span class="n">actor_learning</span><span class="p">.</span><span class="nf">save_weights</span><span class="p">(</span><span class="s">'actor_trainedmodel_sac.h5'</span><span class="p">)</span>
            <span class="n">critic_one_learning</span><span class="p">.</span><span class="nf">save_weights</span><span class="p">(</span><span class="s">'critic_one_trainedmodel_sac.h5'</span><span class="p">)</span>
            <span class="n">critic_two_learning</span><span class="p">.</span><span class="nf">save_weights</span><span class="p">(</span><span class="s">'critic_two_trainedmodel_sac.h5'</span><span class="p">)</span>
                    
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="s">'trajectory_actions_test_sac.txt'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">testcase_actions</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="s">'trajectory_battenergy_test_sac.txt'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">testcase_battenergy</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                        
        <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>   
        <span class="n">elapsedtime_test</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">elapsed_time</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Validation: profit of epoch {} is {}, maximum profit is {}"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span><span class="nf">round</span><span class="p">(</span><span class="n">epoch_return_test</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="nf">round</span><span class="p">(</span><span class="n">max_return_test</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">'one epoch ÏàòÌñâÏóê {}Ï¥à Í±∏Î†∏ÏäµÎãàÎã§'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="nf">round</span><span class="p">(</span><span class="n">elapsed_time</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">'Temperature parameter Í∞íÏùÄ {}ÏûÖÎãàÎã§.'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">alpha</span><span class="p">.</span><span class="nf">numpy</span><span class="p">()))</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="s">'trajectory_time_test_sac.txt'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">elapsedtime_test</span><span class="p">:</span>
                <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>(ÏΩîÎìú ÏÑ§Î™Ö -&gt; DDPG ÎåÄÎπÑ Îã§Î•∏ Î∂ÄÎ∂ÑÎßå)</p>

<p>SAC ÌõàÎ†®ÏóêÏÑú Ï£ºÏùòÌï† Ï†êÏùÄ, Í∞ÄÎÅî $\alpha$Í∞Ä NaNÏù¥ ÎêòÍ∏∞ÎèÑ ÌïúÎã§Îäî Í≤ÉÏù¥Îã§. ÏÜîÏßÅÌûà ÏïÑÏßÅÏùÄ Ïù¥Ïú†Î•º Î™®Î•¥Í≤†Îã§‚Ä¶ ÏÇ¨Ïã§ Ïù¥ Î∂ÄÎ∂ÑÏùÄ 100% Ïù¥Ìï¥Î•º Ìïú Í≤å ÏïÑÎãàÎùºÏÑú ÏúÑ reference pageÏóêÏÑú Ìïú Î∞©ÏãùÏùÑ Í∑∏ÎåÄÎ°ú Ïì¥ Í≤ÉÏù¥Îã§. ÏïÑÎ¨¥Ìäº NaNÏù¥ ÎêòÎ©¥ Îçî Ïù¥ÏÉÅ ÌõàÎ†®Ïù¥ ÎêòÏßÄ ÏïäÏúºÎãà, learning rateÎ•º Îçî Ï§ÑÏù¥Í±∞ÎÇò Ìïú ÌõÑ Ï≤òÏùåÎ∂ÄÌÑ∞ Îã§Ïãú ÌõàÎ†®ÏùÑ ÏãúÏºúÏïº ÌïúÎã§.</p>

<p><br /></p>

<h2 id="Í≤∞Í≥º">Í≤∞Í≥º</h2>

<p>Í≤∞Í≥ºÎ•º Î≥¥Î©¥, TD3ÏóêÏÑúÎèÑ Ïó¨Ï†ÑÌûà DDPGÏ≤òÎüº ÏùºÎ∂ÄÏÜ°Ï†Ñ/ÏùºÎ∂ÄÏàòÏ†Ñ Ïù¥ ÏûàÏúºÎ©∞, ÎÇÆÏóê ÏÜ°Ï†ÑÌïòÎäî Í∏∞Í∞ÑÏóê Ï≠â ÏµúÎåÄÏÜ°Ï†ÑÏóê Í∞ÄÍπùÍ≤å ÌïòÏßÄ ÏïäÍ≥† ÏÜ°Ï†ÑÎüâÏùÑ Ï§ÑÏòÄÎã§Í∞Ä Îã§Ïãú ÎäòÎ¶¨Îäî Ìå®ÌÑ¥Ïù¥ Î≥¥Ïù∏Îã§. ÌïúÌé∏ SACÏùò Í≤ΩÏö∞ ÏµúÎåÄÏÜ°Ï†ÑÍ≥º ÏµúÎåÄÏàòÏ†ÑÍπåÏßÄ Í∞ÄÎäî Í≤ΩÏö∞Í∞Ä Í±∞Ïùò ÏóÜÎã§.</p>

<p>(Í∑∏Î¶º)</p>

<p>TD3ÏôÄ SACÎ°ú ÌõàÎ†® Ïãú validation caseÏóê ÎåÄÌïú ÎàÑÏ†Å ÎπÑÏö©ÏùÄ Í∞ÅÍ∞Å 85Ïú†Î°ú, 118Ïú†Î°úÏù¥Îã§. Ïù¥Îäî DDPG (125Ïú†Î°ú) Î≥¥Îã§Îäî Ï°∞Í∏à ÎÇòÏùÄ Í≤∞Í≥ºÏßÄÎßå, Ïó¨Ï†ÑÌûà Deep Q-learning (50Ïú†Î°ú) Ïóê Îí§ÏßÑÎã§.</p>

<p>Ìï¥Îãπ ÎßàÏù¥ÌÅ¨Î°úÍ∑∏Î¶¨Îìú caseÏóêÏÑúÎäî LP solutionÏóêÏÑúÏùò actionÏù¥ ÏóÑÎ∞ÄÌûàÎäî continuousÏßÄÎßå Í±∞Ïùò discreteÏóê Í∞ÄÍπåÏö¥ Î™®ÏäµÏù¥Í∏∞ ÎïåÎ¨∏Ïóê, actionÏùÑ stateÏùò continuous functionÏúºÎ°ú Í∑ºÏÇ¨ÌïòÎäî DDPG/ TD3/ SACÎ≥¥Îã§Îäî discrete functionÏúºÎ°ú Í∑ºÏÇ¨ÌïòÎäî DQNÏù¥ Îçî ÎÇòÏùÄ Í≤ÉÏúºÎ°ú Ï∂îÏ†ïÎêúÎã§. Ïã¨ÏßÄÏñ¥ Ïù¥Îäî ÏãúÎÆ¨Î†àÏù¥ÏÖòÏóêÏÑú Í≥ÑÏÇ∞ÎêòÎäî ÎàÑÏ†ÅÎπÑÏö© Ï∏°Î©¥ÏóêÏÑúÎßå ÏÉùÍ∞ÅÌïú Í≤ÉÏù¥Î©∞, Í≥ÑÏÇ∞ ÏãúÍ∞ÑÍπåÏßÄ Í≥†Î†§ÌïòÎ©¥ DQNÏùò Í≥ÑÏÇ∞ Ìö®Ïú® (computational efficiency) Ïù¥ Ìõ®Ïî¨ ÎÜíÎã§.
(Í≥ÑÏÇ∞ ÏãúÍ∞ÑÏùÑ ÎπÑÍµêÌï¥ Î≥¥Ïó¨Ï£ºÎäî Í∑∏ÎûòÌîÑ ÎòêÎäî Ìëú)</p>

<p>Ïã§Ï†úÎ°ú ÏóêÎÑàÏßÄÍ∏∞Ïà†Ïó∞Íµ¨ÏõêÏóêÏÑú ÌûàÌä∏ÌéåÌîÑ Ï†úÏñ¥Í∏∞Î•º Ïã¨Ï∏µÍ∞ïÌôîÌïôÏäµÏúºÎ°ú ÌõàÎ†®ÏãúÌÇ® Ïó∞Íµ¨ÏóêÏÑúÎèÑ, SAC Í∏∞Î∞ò continuous control ÎåÄÏã† DQNÏúºÎ°ú discrete controlÏùÑ Ìïú Í≤ÉÏúºÎ°ú ÏïåÎ†§Ï†∏ ÏûàÎã§ (ÌûàÌä∏ÌéåÌîÑÏùò Í≤ΩÏö∞ Ïó¨Îü¨ ÎåÄÎ•º ÏÑ§Ïπò ÌõÑ Îß§ ÏãúÍ∞ÑÎ≥ÑÎ°ú Î™á ÎåÄÎÇò Í∞ÄÎèôÌï† Í≤ÉÏù¥ÎÉêÎ•º Í≤∞Ï†ïÌïòÎäî discrete controlÏù¥ Í∞ÄÎä•ÌïòÍ∏∞ÎèÑ ÌïòÎã§).</p>

<!-- Courtesy of embedresponsively.com -->

<div class="responsive-video-container">
    <iframe src="https://www.youtube-nocookie.com/embed/L9Ye1gALFAk" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe>
  </div>

<p><br /></p>

<h2 id="ÎÇòÍ∞ÄÎ©∞">ÎÇòÍ∞ÄÎ©∞</h2>

<p>Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïù¥Ïñ∏Ïä§ÏóêÏÑú ‚ÄòData Generating Process (DGP)Ïóê ÎßûÎäî Î∞©Î≤ïÏùÑ Ïç®Îùº‚Äô ÎùºÎäî Í≤©Ïñ∏Ïù¥ ÏûàÎäîÎç∞, Ïù¥Î≤à ÏÇ¨Î°ÄÎèÑ Ïù¥ÏôÄ Ïú†ÏÇ¨Ìïú ÍµêÌõàÏùÑ Ï£ºÎäî ÏÇ¨Î°ÄÏù∏ Í≤É Í∞ôÎã§.</p>

<p>ÎØ∏ÎûòÎ•º Î™®Îëê ÏïàÎã§Îäî Í∞ÄÏ†ï ÌïòÏóê ÏÑ†ÌòïÍ≥ÑÌöçÎ≤ïÏúºÎ°ú ÏñªÏùÄ optimal solutionÏóêÏÑúÏùò actionÏù¥ discrete actionÍ≥º ÏÉÅÎãπÌûà Ïú†ÏÇ¨Ìï®ÏùÑ, Í∞ïÌôîÌïôÏäµ Í≥ÑÏÇ∞ Ï†ÑÏù¥ ÎØ∏Î¶¨ Ïïå Ïàò ÏûàÏóàÎã§. Í∑∏Î†áÎã§Î©¥ Ïù¥ Î¨∏Ï†úÏóê ÏûàÏñ¥ Îçî ÎßûÎäî Í∞ïÌôîÌïôÏäµ Î∞©Î≤ïÏùÄ discrete control Î∞©Î≤ïÏù¥Î©∞, Íµ≥Ïù¥ continuous control Î∞©Î≤ïÏùÑ ÏãúÎèÑÌï¥ÎèÑ discrete ÎåÄÎπÑ Îçî ÎÇòÏùÄ Í≤∞Í≥ºÎ•º ÏñªÏßÄ Î™ªÌïòÎäî Í≤ÉÏù¥ ÎÜÄÎûçÏßÄ ÏïäÏùÄ Í≤ÉÏù¥Îã§.</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> ÌÉúÍ∑∏: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#beautifulsoup" class="page__taxonomy-item p-category" rel="tag">BeautifulSoup</a><span class="sep">, </span>
    
      <a href="/tags/#python" class="page__taxonomy-item p-category" rel="tag">python</a>
    
    </span>
  </p>



<!-- 
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Ïπ¥ÌÖåÍ≥†Î¶¨: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#energy" class="page__taxonomy-item p-category" rel="tag">Energy</a>
    
    </span>
  </p>

 -->
        <!-- 

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> ÏóÖÎç∞Ïù¥Ìä∏:</strong> <time class="dt-published" datetime="2023-04-19T00:00:00+09:00">2023-04-19</time></p>
 -->
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Í≥µÏú†ÌïòÍ∏∞</h4>
  

  <!-- <a href="https://twitter.com/intent/tweet?text=%EA%B0%95%ED%99%94%ED%95%99%EC%8A%B5+%EA%B8%B0%EB%B0%98+%EB%A7%88%EC%9D%B4%ED%81%AC%EB%A1%9C%EA%B7%B8%EB%A6%AC%EB%93%9C+%EB%82%B4+%EB%B0%B0%ED%84%B0%EB%A6%AC+%EC%8A%A4%EC%BC%80%EC%A4%84%EB%A7%81+-+5%29+TD3%2C+SAC%EB%A5%BC+%ED%86%B5%ED%95%9C+continuous+control+%EB%8F%84%EC%B6%9C%20http%3A%2F%2Flocalhost%3A4000%2F2023%2F04%2Freinforcefive.html" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Í≥µÏú†ÌïòÍ∏∞ Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> -->

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2F2023%2F04%2Freinforcefive.html" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Í≥µÏú†ÌïòÍ∏∞ Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2F2023%2F04%2Freinforcefive.html" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Í≥µÏú†ÌïòÍ∏∞ LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      <p></p>
        <h4 class="page__meta-title"><span>Energy</span> <span>Ïπ¥ÌÖåÍ≥†Î¶¨ ÎÇ¥ Îã§Î•∏ Í∏Ä Î≥¥Îü¨Í∞ÄÍ∏∞</span></h4>
        


  

  
  	
  	
  	
  	
  	

<nav class="pagination_prev_next"> <!-- ÏãùÎπµÎßò ÏΩîÎìúÏóêÏÑú Ï°∞Í∏à ÏàòÏ†ïÌï® -->

  
    
      <a href="/2023/04/monthlyenergyone.html" class="pagination_prev_next--pager"><span class="prev_next">Îã§Ïùå Í∏Ä  &nbsp  </span>Í±¥Ï∂ïÎ¨º Î≥Ñ ÏõîÎ≥Ñ ÏóêÎÑàÏßÄ ÏÇ¨Ïö©Îüâ Îç∞Ïù¥ÌÑ∞ÏÖã - 1) Î™®Îì† ÏõîÏóê ÎåÄÌïú ÌÜµÌï© Î∞è ÌëúÏ†úÎ∂ÄÏôÄÏùò Í≤∞Ìï© ÌõÑ SQLite DBÌôî</a>
    
    
      <a href="/2023/04/reinforcefour.html" class="pagination_prev_next--pager"><span class="prev_next">Ïù¥Ï†Ñ Í∏Ä  &nbsp</span>Í∞ïÌôîÌïôÏäµ Í∏∞Î∞ò ÎßàÏù¥ÌÅ¨Î°úÍ∑∏Î¶¨Îìú ÎÇ¥ Î∞∞ÌÑ∞Î¶¨ Ïä§ÏºÄÏ§ÑÎßÅ - 4) DDPGÎ•º ÌÜµÌïú continuous control ÎèÑÏ∂ú</a>
        
  

</nav>
      <p></p>
    </div>

    
  </article>

  
  <!-- 
    <div class="page__related">
      <h2 class="page__related-title">Ï∞∏Í≥†</h2>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/logo.png" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2023/04/monthlyenergyone.html" rel="permalink">Í±¥Ï∂ïÎ¨º Î≥Ñ ÏõîÎ≥Ñ ÏóêÎÑàÏßÄ ÏÇ¨Ïö©Îüâ Îç∞Ïù¥ÌÑ∞ÏÖã - 1) Î™®Îì† ÏõîÏóê ÎåÄÌïú ÌÜµÌï© Î∞è ÌëúÏ†úÎ∂ÄÏôÄÏùò Í≤∞Ìï© ÌõÑ SQLite DBÌôî
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-04-20T00:00:00+09:00">2023-04-20</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">ÌïÑÏûêÏóêÍ≤å ÏûàÏñ¥ Í∞ÅÎ≥ÑÌïú Îç∞Ïù¥ÌÑ∞ÏÖãÏù¥ ÏûàÎã§. (ÎπÑÏ£ºÍ±∞Ïö©) Í±¥Ï∂ïÎ¨º Î≥Ñ ÏõîÎ≥Ñ ÏóêÎÑàÏßÄ ÏÇ¨Ïö©Îüâ Îç∞Ïù¥ÌÑ∞ÏÖãÏù¥Îã§. Í∞ÅÏßÄÎ≤à Ï£ºÏÜå Îã®ÏúÑÏùò Í∞úÎ≥Ñ ÎπÑÏ£ºÍ±∞Ïö© Í±¥Î¨ºÎ≥ÑÎ°ú ÌäπÏ†ï ÏõîÏóê ÏÜåÎπÑÌïú Ï†ÑÍ∏∞ÏôÄ Í∞ÄÏä§Ïùò ÏñëÏùÑ kWh Îã®ÏúÑÎ°ú Í∏∞Î°ùÌïú Îç∞Ïù¥ÌÑ∞ÏÖãÏù¥Îã§.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/logo.png" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2023/04/reinforcefour.html" rel="permalink">Í∞ïÌôîÌïôÏäµ Í∏∞Î∞ò ÎßàÏù¥ÌÅ¨Î°úÍ∑∏Î¶¨Îìú ÎÇ¥ Î∞∞ÌÑ∞Î¶¨ Ïä§ÏºÄÏ§ÑÎßÅ - 4) DDPGÎ•º ÌÜµÌïú continuous control ÎèÑÏ∂ú
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-04-18T00:00:00+09:00">2023-04-18</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Ï†ÄÎ≤à Ìè¨Ïä§ÌåÖÏóêÏÑúÎäî ÎßàÏù¥ÌÅ¨Î°úÍ∑∏Î¶¨ÎìúÏóê discrete action Í∏∞Î∞òÏùò Ïã¨Ï∏µÍ∞ïÌôîÌïôÏäµÏùÑ Ï†ÅÏö©Ìï¥ Í≥ºÍ±∞ ÏãúÏ†êÏùòÎç∞Ïù¥ÌÑ∞ Í∏∞Î∞òÏúºÎ°ú controlÏùÑ Í≤∞Ï†ïÌïòÎäî Î∞©Î≤ïÏùÑ ÏïåÏïÑÎ≥¥ÏïòÎã§. Í∑∏Îü¨ÎÇò Ïã§Ï†úÎ°úÎäî continuous actionÏù¥ÎØÄÎ°ú, continuous actionÏùÑ Îã§Î£®Îäî Ïã¨Ï∏µÍ∞ïÌôîÌïôÏäµ Í∏∞Î≤ïÏùÑ Ï†Å...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/logo.png" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2023/04/reinforcethree.html" rel="permalink">Í∞ïÌôîÌïôÏäµ Í∏∞Î∞ò ÎßàÏù¥ÌÅ¨Î°úÍ∑∏Î¶¨Îìú ÎÇ¥ Î∞∞ÌÑ∞Î¶¨ Ïä§ÏºÄÏ§ÑÎßÅ - 3) Deep Q-learningÏùÑ ÌÜµÌïú discrete control ÎèÑÏ∂ú
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-04-17T00:00:00+09:00">2023-04-17</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Ïù¥Ï†Ñ Ìè¨Ïä§ÌåÖÏóêÏÑúÎèÑ Ïñ∏Í∏âÌñàÎìØ, Ïù¥ Î¨∏Ï†úÏóêÏÑú stateÎäî ÏßÅÏ†Ñ 24ÏãúÍ∞Ñ ÎèôÏïàÏùò ÌÉúÏñëÍ¥ë Î∞úÏ†ÑÎüâÍ≥º Î∂ÄÌïò Î∞è ÏßÅÏ†Ñ 1ÏãúÍ∞ÑÏùò Î∞∞ÌÑ∞Î¶¨ ÎÇ¥ ÏóêÎÑàÏßÄÏñëÏù¥Í≥†, actionÏùÄ 1.1kW ÏàòÏ†Ñ/ 1.1kW ÏÜ°Ï†Ñ/ idle 3Í∞ÄÏßÄÏù¥Îã§. (action Ïù∏Îç±Ïä§Îäî 0,1,2Îùº ÌïòÏûê). Ïù¥ Îïå Ïã¨Ï∏µÏã†Í≤ΩÎßùÏùÄ sta...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/logo.png" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2023/04/reinforcetwo.html" rel="permalink">Í∞ïÌôîÌïôÏäµ Í∏∞Î∞ò ÎßàÏù¥ÌÅ¨Î°úÍ∑∏Î¶¨Îìú ÎÇ¥ Î∞∞ÌÑ∞Î¶¨ Ïä§ÏºÄÏ§ÑÎßÅ - 2) Q-learning Í∞úÎÖê
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-04-16T00:00:00+09:00">2023-04-16</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">ÏßÄÎÇú Ìè¨Ïä§ÌåÖÏóêÏÑú ÌÉúÏñëÍ¥ë Í∏∞Î∞ò ÎßàÏù¥ÌÅ¨Î°úÍ∑∏Î¶¨ÎìúÏùò ÎàÑÏ†Å ÎπÑÏö©ÏùÑ ÏµúÏÜåÌôîÌïòÎäî ÏµúÏ†Å control Î¨∏Ï†úÎ•º ÏÜåÍ∞úÌñàÎã§. Ïù¥Î≤à Ìè¨Ïä§ÌåÖÏóêÏÑúÎäî ‚ÄòÎß§ ÏãúÏ†êÎ≥ÑÎ°ú Í≥ºÍ±∞Ïùò ÏûêÎ£åÎßåÏùÑ Í∞ñÍ≥†‚Äô controlÌïòÎäî Îç∞ ÌïÑÏöîÌïú Í∞ïÌôîÌïôÏäµÏùò Ïù¥Î°†Ï†Å ÎÇ¥Ïö©ÏùÑ ÏµúÎåÄÌïú Í∞ÑÎã®Ìûà ÏÜåÍ∞úÌïúÎã§ (Í∞ïÌôîÌïôÏäµÏóê ÎåÄÌïú ÏÉÅÏÑ∏ ÎÇ¥Ïö©ÏùÄ SuttonÏùò...</p>
  </article>
</div>

        
      </div>
    </div> -->
  
  <!--  -->
</div>

  </div>

  

  <aside class="sidebar__top">
    <a href="#site-nav"> <i class="fas fa-angle-double-up fa-2x"></i></a>
    </aside>

  <div id="footer" class="page__footer">
    <footer>
      <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
      <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>ÌåîÎ°úÏö∞:</strong></li>
    

    
      
        
          <li><a href="https://blog.naver.com/song4energy" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> ÌîºÎìú</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 Jeonghun Song. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

    </footer>
  </div>

  
  <script src="/assets/js/main.min.js"></script>










</body>

</html>